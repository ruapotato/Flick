#!/bin/bash
# Flick session startup script
# Starts lisgd for gestures, then the Flick shell
#
# This script is for development/manual use. For display manager sessions,
# use install-session.sh to install the proper session script.

export XDG_CURRENT_DESKTOP=Flick
export XDG_SESSION_TYPE=wayland

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FLICK_ROOT="${FLICK_ROOT:-$(dirname "$SCRIPT_DIR")}"
LOG_DIR="$HOME/.local/share/flick/logs"

mkdir -p "$LOG_DIR"

log_msg() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [flick-session] $*" | tee -a "$LOG_DIR/session.log"
}

# Track child processes
LISGD_PID=""

cleanup() {
    log_msg "Cleaning up..."
    [ -n "$LISGD_PID" ] && kill "$LISGD_PID" 2>/dev/null
    log_msg "Session ended"
    exit 0
}

trap cleanup EXIT INT TERM HUP

log_msg "=== Flick session starting ==="

# Find the shell binary
SHELL_BIN=""
for path in \
    "$FLICK_ROOT/shell/build/linux/x64/release/bundle/flick_shell" \
    "$FLICK_ROOT/shell/build/linux/arm64/release/bundle/flick_shell" \
    "$FLICK_ROOT/shell/build/linux/x64/debug/bundle/flick_shell" \
    "$FLICK_ROOT/shell/build/linux/arm64/debug/bundle/flick_shell"
do
    if [ -x "$path" ]; then
        SHELL_BIN="$path"
        break
    fi
done

if [ -z "$SHELL_BIN" ]; then
    log_msg "ERROR: Flick shell not found. Build with: cd shell && flutter build linux --release"
    exit 1
fi

log_msg "Using shell: $SHELL_BIN"

# Start lisgd for edge gestures (in background)
start_lisgd() {
    # Small delay to let Wayland environment settle
    sleep 1
    "$SCRIPT_DIR/lisgd.sh" >> "$LOG_DIR/lisgd.log" 2>&1
}
start_lisgd &
LISGD_PID=$!
log_msg "Started lisgd (PID: $LISGD_PID)"

# Start the Flick shell
log_msg "Starting Flick shell..."
"$SHELL_BIN"
EXIT_CODE=$?

log_msg "Flick shell exited with code $EXIT_CODE"
# cleanup runs via trap
