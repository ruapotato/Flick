#!/bin/bash
# Flick Settings Control Helper
# This script provides system integration for the Settings app

set -e

LOCK_CONFIG_PATH="${HOME}/.local/state/flick/lock_config.json"

usage() {
    echo "Usage: $0 <command> [args...]"
    echo "Commands:"
    echo "  brightness get        - Get current brightness (0-100)"
    echo "  brightness set <val>  - Set brightness (0-100)"
    echo "  volume get            - Get current volume (0-100)"
    echo "  volume set <val>      - Set volume (0-100)"
    echo "  mute get              - Get mute status (0/1)"
    echo "  mute set <0|1>        - Set mute status"
    echo "  lock get              - Get lock method (pin/password/pattern/none)"
    echo "  lock set <method>     - Set lock method"
    exit 1
}

[ $# -lt 2 ] && usage

CMD="$1"
ACTION="$2"
VALUE="${3:-}"

case "$CMD" in
    brightness)
        case "$ACTION" in
            get)
                # Try brightnessctl first, then fall back to sysfs
                if command -v brightnessctl &>/dev/null; then
                    val=$(brightnessctl -m | cut -d',' -f4 | tr -d '%')
                    echo "${val:-50}"
                else
                    # Find first backlight
                    for bl in /sys/class/backlight/*; do
                        if [ -f "$bl/brightness" ] && [ -f "$bl/max_brightness" ]; then
                            cur=$(cat "$bl/brightness")
                            max=$(cat "$bl/max_brightness")
                            echo $(( cur * 100 / max ))
                            exit 0
                        fi
                    done
                    echo 50
                fi
                ;;
            set)
                [ -z "$VALUE" ] && usage
                if command -v brightnessctl &>/dev/null; then
                    brightnessctl set "${VALUE}%" &>/dev/null
                else
                    for bl in /sys/class/backlight/*; do
                        if [ -f "$bl/brightness" ] && [ -f "$bl/max_brightness" ]; then
                            max=$(cat "$bl/max_brightness")
                            new=$(( VALUE * max / 100 ))
                            echo "$new" > "$bl/brightness" 2>/dev/null || true
                            exit 0
                        fi
                    done
                fi
                ;;
            *)
                usage
                ;;
        esac
        ;;
    volume)
        case "$ACTION" in
            get)
                # Try pactl (PulseAudio) first, then wpctl (PipeWire)
                if command -v pactl &>/dev/null; then
                    vol=$(pactl get-sink-volume @DEFAULT_SINK@ 2>/dev/null | grep -oP '\d+%' | head -1 | tr -d '%')
                    echo "${vol:-50}"
                elif command -v wpctl &>/dev/null; then
                    vol=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null | grep -oP '[\d.]+' | head -1)
                    echo $(echo "$vol * 100" | bc 2>/dev/null || echo 50)
                else
                    echo 50
                fi
                ;;
            set)
                [ -z "$VALUE" ] && usage
                if command -v pactl &>/dev/null; then
                    pactl set-sink-volume @DEFAULT_SINK@ "${VALUE}%" &>/dev/null || true
                elif command -v wpctl &>/dev/null; then
                    wpctl set-volume @DEFAULT_AUDIO_SINK@ "$(echo "$VALUE / 100" | bc -l)%" &>/dev/null || true
                fi
                ;;
            *)
                usage
                ;;
        esac
        ;;
    mute)
        case "$ACTION" in
            get)
                if command -v pactl &>/dev/null; then
                    muted=$(pactl get-sink-mute @DEFAULT_SINK@ 2>/dev/null | grep -oP '(yes|no)')
                    [ "$muted" = "yes" ] && echo 1 || echo 0
                elif command -v wpctl &>/dev/null; then
                    muted=$(wpctl get-volume @DEFAULT_AUDIO_SINK@ 2>/dev/null | grep -q MUTED && echo 1 || echo 0)
                    echo "$muted"
                else
                    echo 0
                fi
                ;;
            set)
                [ -z "$VALUE" ] && usage
                if command -v pactl &>/dev/null; then
                    [ "$VALUE" = "1" ] && pactl set-sink-mute @DEFAULT_SINK@ 1 || pactl set-sink-mute @DEFAULT_SINK@ 0
                elif command -v wpctl &>/dev/null; then
                    [ "$VALUE" = "1" ] && wpctl set-mute @DEFAULT_AUDIO_SINK@ 1 || wpctl set-mute @DEFAULT_AUDIO_SINK@ 0
                fi
                ;;
            *)
                usage
                ;;
        esac
        ;;
    lock)
        case "$ACTION" in
            get)
                if [ -f "$LOCK_CONFIG_PATH" ]; then
                    # Extract method from JSON
                    grep -oP '"method"\s*:\s*"\K[^"]+' "$LOCK_CONFIG_PATH" 2>/dev/null || echo "password"
                else
                    echo "password"
                fi
                ;;
            set)
                [ -z "$VALUE" ] && usage
                # Validate method
                case "$VALUE" in
                    pin|password|pattern|none)
                        mkdir -p "$(dirname "$LOCK_CONFIG_PATH")"
                        echo "{\"method\": \"$VALUE\"}" > "$LOCK_CONFIG_PATH"
                        echo "Lock method set to: $VALUE"
                        ;;
                    *)
                        echo "Invalid method: $VALUE (use pin/password/pattern/none)"
                        exit 1
                        ;;
                esac
                ;;
            set-pin)
                # VALUE should be the PIN (4-6 digits)
                [ -z "$VALUE" ] && { echo "Usage: $0 lock set-pin <pin>"; echo "PIN format: 4-6 digits"; exit 1; }

                # Validate PIN format (only digits, 4-6 chars)
                if ! echo "$VALUE" | grep -qE '^[0-9]{4,6}$'; then
                    echo "Invalid PIN format. Use 4-6 digits"
                    exit 1
                fi

                # Generate bcrypt hash using Python
                HASH=$(python3 -c "
import bcrypt
pin = '$VALUE'
hash = bcrypt.hashpw(pin.encode(), bcrypt.gensalt()).decode()
print(hash)
" 2>/dev/null)

                if [ -z "$HASH" ]; then
                    echo "Error: Could not generate bcrypt hash (install python3-bcrypt)"
                    exit 1
                fi

                # Save config with hash
                mkdir -p "$(dirname "$LOCK_CONFIG_PATH")"
                cat > "$LOCK_CONFIG_PATH" << EOF
{
  "method": "pin",
  "pin_hash": "$HASH",
  "pattern_hash": null,
  "timeout_seconds": 300,
  "max_attempts": 5
}
EOF
                echo "PIN saved successfully"
                ;;
            set-pattern)
                # VALUE should be comma-separated node indices like "0,3,6,7,8"
                [ -z "$VALUE" ] && { echo "Usage: $0 lock set-pattern <pattern>"; echo "Pattern format: comma-separated node indices (0-8), e.g., 0,3,6,7,8"; exit 1; }

                # Validate pattern format (only digits 0-8 and commas)
                if ! echo "$VALUE" | grep -qE '^[0-8](,[0-8])*$'; then
                    echo "Invalid pattern format. Use comma-separated digits 0-8"
                    exit 1
                fi

                # Count nodes (at least 4 required)
                NODE_COUNT=$(echo "$VALUE" | tr ',' '\n' | wc -l)
                if [ "$NODE_COUNT" -lt 4 ]; then
                    echo "Pattern too short (minimum 4 nodes, got $NODE_COUNT)"
                    exit 1
                fi

                # Generate bcrypt hash using Python
                HASH=$(python3 -c "
import bcrypt
pattern = '$VALUE'
hash = bcrypt.hashpw(pattern.encode(), bcrypt.gensalt()).decode()
print(hash)
" 2>/dev/null)

                if [ -z "$HASH" ]; then
                    # Python bcrypt not available, try using the flick binary
                    HASH=$("$HOME/Flick/shell/target/release/flick" --hash-pattern "$VALUE" 2>/dev/null)
                fi

                if [ -z "$HASH" ]; then
                    echo "Error: Could not generate bcrypt hash (install python3-bcrypt)"
                    exit 1
                fi

                # Save config with hash
                mkdir -p "$(dirname "$LOCK_CONFIG_PATH")"
                cat > "$LOCK_CONFIG_PATH" << EOF
{
  "method": "pattern",
  "pin_hash": null,
  "pattern_hash": "$HASH",
  "timeout_seconds": 300,
  "max_attempts": 5
}
EOF
                echo "Pattern saved successfully"
                ;;
            *)
                usage
                ;;
        esac
        ;;
    *)
        usage
        ;;
esac
