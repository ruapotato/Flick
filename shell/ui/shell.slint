// Flick Shell UI - Mobile-first Linux shell
// Uses Slint declarative UI with Material Design inspired styling

import { Button, VerticalBox, HorizontalBox, GridBox, ScrollView } from "std-widgets.slint";

// Color scheme - dark mobile theme
global Theme {
    out property <color> background: #0a0a0f;
    out property <color> surface: #1a1a24;
    out property <color> surface-variant: #252532;
    out property <color> primary: #4a9eff;
    out property <color> primary-container: #1a3a5c;
    out property <color> on-surface: #ffffff;
    out property <color> on-surface-variant: #a0a0b0;
    out property <color> error: #ff6b6b;
    out property <color> success: #4ade80;
}

// Simple brightness slider (custom, software renderer compatible)
component BrightnessSlider inherits Rectangle {
    in property <float> value: 0.5;  // 0.0 to 1.0
    callback changed(float);

    height: 40px;
    background: Theme.surface-variant;
    border-radius: 8px;

    // Track background
    Rectangle {
        x: 8px;
        y: (parent.height - 8px) / 2;
        width: parent.width - 16px;
        height: 8px;
        border-radius: 4px;
        background: Theme.background;

        // Filled portion
        Rectangle {
            width: parent.width * root.value;
            height: 100%;
            border-radius: 4px;
            background: Theme.primary;
        }
    }

    // Thumb
    Rectangle {
        x: 8px + (parent.width - 16px - 24px) * root.value;
        y: (parent.height - 24px) / 2;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        background: Theme.on-surface;
    }

    touch := TouchArea {
        moved => {
            if self.pressed {
                // Calculate new value: (mouse-x - 8px) / (width - 16px), clamped 0-1
                root.changed(max(0.0, min(1.0, (self.mouse-x - 8px) / (parent.width - 16px))));
            }
        }
        clicked => {
            // Calculate new value on click
            root.changed(max(0.0, min(1.0, (self.mouse-x - 8px) / (parent.width - 16px))));
        }
    }
}

// App category for home screen
export struct AppCategory {
    name: string,
    icon: string,
    color: color,
}

// Available app for picking default
export struct AvailableApp {
    name: string,
    exec: string,
}

// Notification data structure
export struct Notification {
    id: int,
    app-name: string,
    app-icon: string,
    title: string,
    body: string,
    time: string,
    urgency: int,  // 0=low, 1=normal, 2=critical
}

// Window card for app switcher
export struct WindowCard {
    id: int,
    title: string,
    app-class: string,
}

// Status bar at top of screen
component StatusBar inherits Rectangle {
    in property <string> time: "12:00";
    in property <int> battery: 85;
    in property <bool> wifi: true;

    height: 48px;
    background: transparent;

    HorizontalLayout {
        padding-left: 16px;
        padding-right: 16px;
        spacing: 8px;

        // Time (left)
        Text {
            text: time;
            color: Theme.on-surface;
            font-size: 16px;
            font-weight: 600;
            vertical-alignment: center;
        }

        Rectangle { horizontal-stretch: 1; }

        // Status icons (right)
        HorizontalLayout {
            spacing: 12px;

            // WiFi indicator
            Text {
                text: wifi ? "W" : "-";
                color: wifi ? Theme.primary : Theme.on-surface-variant;
                font-size: 14px;
                vertical-alignment: center;
            }

            // Battery
            Text {
                text: battery + "%";
                color: battery > 20 ? Theme.success : Theme.error;
                font-size: 14px;
                vertical-alignment: center;
            }
        }
    }
}

// Home indicator at bottom
component HomeIndicator inherits Rectangle {
    height: 34px;
    background: transparent;

    Rectangle {
        x: (parent.width - self.width) / 2;
        y: 8px;
        width: 134px;
        height: 5px;
        border-radius: 2.5px;
        background: Theme.on-surface-variant.with-alpha(0.5);
    }
}

// Popup menu button
component PopupButton inherits Rectangle {
    in property <string> label: "Button";
    in property <bool> highlighted: false;

    callback clicked();

    height: 56px;
    background: touch.pressed ? Theme.primary-container : (highlighted ? Theme.surface-variant : transparent);
    border-radius: 12px;

    HorizontalLayout {
        padding-left: 20px;
        padding-right: 20px;

        Text {
            text: label;
            color: Theme.on-surface;
            font-size: 16px;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// Long press popup menu - shows "Pick Default" and "Move" options
component LongPressPopup inherits Rectangle {
    in property <string> category-name: "App";
    in property <bool> can-pick-default: true;  // Settings can't pick default

    callback pick-default-clicked();
    callback move-clicked();
    callback close-clicked();

    width: 280px;
    height: can-pick-default ? 180px : 130px;
    border-radius: 20px;
    background: Theme.surface;
    // Note: drop-shadow not supported in software renderer
    border-width: 1px;
    border-color: Theme.surface-variant;

    VerticalLayout {
        padding: 16px;
        spacing: 8px;

        // Title
        Text {
            text: category-name;
            color: Theme.on-surface;
            font-size: 18px;
            font-weight: 600;
            horizontal-alignment: center;
        }

        Rectangle { height: 8px; }

        // Pick Default button (only if customizable)
        if can-pick-default: PopupButton {
            label: "Pick Default App";
            clicked => { pick-default-clicked(); }
        }

        // Move button
        PopupButton {
            label: "Move Icon";
            clicked => { move-clicked(); }
        }
    }

    // Close when tapping outside (background touch area behind everything)
}

// App list item for pick default view
component AppListItem inherits Rectangle {
    in property <string> name: "App Name";
    in property <bool> is-selected: false;

    callback clicked();

    height: 64px;
    background: touch.pressed ? Theme.primary-container : (is-selected ? Theme.surface-variant : transparent);

    HorizontalLayout {
        padding-left: 20px;
        padding-right: 20px;
        spacing: 16px;

        // App icon placeholder
        Rectangle {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: Theme.surface-variant;

            Text {
                width: 100%;
                height: 100%;
                text: "â€¢";
                color: Theme.on-surface;
                font-size: 20px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        Text {
            text: name;
            color: Theme.on-surface;
            font-size: 16px;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }

        if is-selected: Text {
            text: "âœ“";
            color: Theme.primary;
            font-size: 20px;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// Pick default app view - shows list of available apps for a category
component PickDefaultView inherits Rectangle {
    in property <string> category-name: "App";
    in property <[AvailableApp]> available-apps: [];
    in property <string> current-selection: "";

    callback app-selected(string);  // Returns exec command
    callback back-pressed();

    width: 100%;
    height: 100%;
    background: Theme.background;

    VerticalLayout {
        // Header
        Rectangle {
            height: 80px;
            background: Theme.surface;

            HorizontalLayout {
                padding: 20px;
                spacing: 16px;

                // Back button
                Rectangle {
                    width: 44px;
                    height: 44px;
                    border-radius: 22px;
                    background: back-touch.pressed ? Theme.primary-container : Theme.surface-variant;

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "<";
                        color: Theme.on-surface;
                        font-size: 20px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    back-touch := TouchArea {
                        clicked => { back-pressed(); }
                    }
                }

                VerticalLayout {
                    alignment: center;
                    spacing: 2px;

                    Text {
                        text: "Pick Default";
                        color: Theme.on-surface;
                        font-size: 20px;
                        font-weight: 600;
                    }

                    Text {
                        text: category-name;
                        color: Theme.on-surface-variant;
                        font-size: 14px;
                    }
                }
            }
        }

        // App list
        ScrollView {
            vertical-stretch: 1;

            VerticalLayout {
                padding: 8px;
                spacing: 4px;

                for app[i] in available-apps: AppListItem {
                    name: app.name;
                    is-selected: app.exec == current-selection;
                    clicked => { app-selected(app.exec); }
                }

                // Empty state
                if available-apps.length == 0: Rectangle {
                    height: 100px;

                    Text {
                        text: "No apps available";
                        color: Theme.on-surface-variant;
                        font-size: 16px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}

// Done button for wiggle mode
component WiggleDoneButton inherits Rectangle {
    callback clicked();

    height: 56px;
    background: Theme.primary;
    border-radius: 28px;

    HorizontalLayout {
        alignment: center;

        Text {
            text: "Done";
            color: Theme.on-surface;
            font-size: 18px;
            font-weight: 600;
            vertical-alignment: center;
        }
    }

    TouchArea {
        clicked => { root.clicked(); }
    }
}

// App tile for home screen grid
component AppTile inherits Rectangle {
    in property <string> name: "App";
    in property <string> icon: "A";
    in property <color> tile-color: Theme.primary;
    in property <bool> wiggling: false;
    in property <int> wiggle-phase: 0;  // Phase offset for varied animation
    in property <bool> is-dragging: false;  // True when this tile is being dragged
    in property <float> wiggle-time: 0;  // Time value for wiggle animation (set from Rust)

    callback clicked();
    callback drag-started(float, float);  // x, y position
    callback drag-moved(float, float);    // x, y position
    callback drag-ended(float, float);    // x, y position

    width: 100%;
    height: 100%;
    // Visual feedback when pressed or dragging
    background: (touch-area.pressed || is-dragging) ? Theme.surface-variant.with-alpha(0.3) : transparent;
    // Scale up slightly when dragging
    opacity: is-dragging ? 0.8 : 1.0;

    // Wiggle animation - x/y offset using sin/cos (software renderer compatible)
    property <length> wiggle-x: wiggling && !is-dragging ? sin((wiggle-time * 12 + wiggle-phase * 0.7) * 1rad) * 3px : 0px;
    property <length> wiggle-y: wiggling && !is-dragging ? cos((wiggle-time * 10 + wiggle-phase * 0.5) * 1rad) * 2px : 0px;

    // Container for the icon with wiggle offset (not in a layout so we can position it)
    Rectangle {
        x: (parent.width - 80px) / 2 + root.wiggle-x;
        y: 10px + root.wiggle-y;
        width: 80px;
        height: 80px;
        border-radius: 20px;
        background: tile-color;

        Text {
            width: 100%;
            height: 100%;
            text: icon;
            color: Theme.on-surface;
            font-size: 36px;
            font-weight: 700;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    // Name label at bottom
    Text {
        x: 0;
        y: 100px;
        width: 100%;
        height: 30px;
        text: name;
        color: Theme.on-surface-variant;
        font-size: 14px;
        horizontal-alignment: center;
        overflow: elide;
    }

    // Track if we started a drag
    property <bool> drag-active: false;

    // TouchArea - handles both clicks and drag gestures during wiggle mode
    touch-area := TouchArea {
        width: 100%;
        height: 100%;

        clicked => {
            if !wiggling {
                root.clicked();
            }
        }

        pointer-event(event) => {
            if wiggling {
                if event.kind == PointerEventKind.down {
                    root.drag-active = true;
                    root.drag-started(self.mouse-x / 1px, self.mouse-y / 1px);
                } else if event.kind == PointerEventKind.up || event.kind == PointerEventKind.cancel {
                    if root.drag-active {
                        root.drag-active = false;
                        root.drag-ended(self.mouse-x / 1px, self.mouse-y / 1px);
                    }
                }
            }
        }

        moved => {
            if wiggling && root.drag-active {
                root.drag-moved(self.mouse-x / 1px, self.mouse-y / 1px);
            }
        }
    }
}

// Notification card component
component NotificationCard inherits Rectangle {
    in property <string> app-name: "App";
    in property <string> app-icon: "ðŸ“±";
    in property <string> title: "Notification";
    in property <string> body: "Message body";
    in property <string> time: "now";
    in property <int> urgency: 1;

    callback dismissed();
    callback tapped();

    height: 80px;
    border-radius: 12px;
    background: urgency == 2 ? Theme.error.with-alpha(0.2) : Theme.surface-variant;
    clip: true;

    HorizontalLayout {
        padding: 12px;
        spacing: 12px;

        // App icon
        Rectangle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: Theme.primary.with-alpha(0.2);

            Text {
                text: app-icon;
                font-size: 20px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Content
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;
            alignment: center;

            HorizontalLayout {
                Text {
                    text: app-name;
                    color: Theme.on-surface;
                    font-size: 12px;
                    font-weight: 600;
                    horizontal-stretch: 1;
                }
                Text {
                    text: time;
                    color: Theme.on-surface-variant;
                    font-size: 10px;
                }
            }

            Text {
                text: title;
                color: Theme.on-surface;
                font-size: 14px;
                font-weight: 500;
                overflow: elide;
            }

            Text {
                text: body;
                color: Theme.on-surface-variant;
                font-size: 12px;
                overflow: elide;
            }
        }

        // Dismiss button
        Rectangle {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: Theme.surface;

            Text {
                text: "Ã—";
                color: Theme.on-surface-variant;
                font-size: 16px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                clicked => { root.dismissed(); }
            }
        }
    }

    TouchArea {
        clicked => { root.tapped(); }
    }
}

// Quick toggle button
component QuickToggle inherits Rectangle {
    in property <string> label: "Toggle";
    in property <string> icon: "T";
    in property <bool> enabled: false;

    callback toggled();

    width: 80px;
    height: 80px;
    border-radius: 16px;
    background: enabled ? Theme.primary : Theme.surface-variant;

    VerticalLayout {
        alignment: center;
        spacing: 4px;

        Text {
            text: icon;
            color: Theme.on-surface;
            font-size: 24px;
            font-weight: 600;
            horizontal-alignment: center;
        }

        Text {
            text: label;
            color: Theme.on-surface.with-alpha(0.8);
            font-size: 10px;
            horizontal-alignment: center;
        }
    }

    TouchArea {
        clicked => { root.toggled(); }
    }
}

// PIN button
component PinButton inherits Rectangle {
    in property <string> digit: "0";
    callback clicked();

    width: 72px;
    height: 72px;
    border-radius: 36px;
    background: touch.pressed ? Theme.primary : Theme.surface-variant;

    Text {
        width: 100%;
        height: 100%;
        text: digit;
        color: Theme.on-surface;
        font-size: 28px;
        font-weight: 500;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// PIN pad for lock screen
component PinPad inherits Rectangle {
    callback digit-pressed(string);
    callback backspace-pressed();

    width: 280px;
    height: 320px;

    GridLayout {
        spacing: 16px;
        padding: 16px;

        Row {
            PinButton { digit: "1"; clicked => { digit-pressed("1"); } }
            PinButton { digit: "2"; clicked => { digit-pressed("2"); } }
            PinButton { digit: "3"; clicked => { digit-pressed("3"); } }
        }
        Row {
            PinButton { digit: "4"; clicked => { digit-pressed("4"); } }
            PinButton { digit: "5"; clicked => { digit-pressed("5"); } }
            PinButton { digit: "6"; clicked => { digit-pressed("6"); } }
        }
        Row {
            PinButton { digit: "7"; clicked => { digit-pressed("7"); } }
            PinButton { digit: "8"; clicked => { digit-pressed("8"); } }
            PinButton { digit: "9"; clicked => { digit-pressed("9"); } }
        }
        Row {
            Rectangle { width: 72px; height: 72px; background: transparent; }
            PinButton { digit: "0"; clicked => { digit-pressed("0"); } }
            PinButton { digit: "<"; clicked => { backspace-pressed(); } }
        }
    }
}

// Lock screen view - fills entire screen
component LockScreen inherits Rectangle {
    in property <string> time: "12:00";
    in property <string> date: "Saturday, December 7";
    in property <int> pin-length: 0;
    in property <string> error-message: "";

    callback digit-pressed(string);
    callback backspace-pressed();

    width: 100%;
    height: 100%;
    background: Theme.background;

    VerticalLayout {
        alignment: center;
        spacing: 24px;
        padding: 32px;

        // Time display
        Text {
            text: time;
            color: Theme.on-surface;
            font-size: 72px;
            font-weight: 300;
            horizontal-alignment: center;
        }

        // Date
        Text {
            text: date;
            color: Theme.on-surface-variant;
            font-size: 18px;
            horizontal-alignment: center;
        }

        Rectangle { height: 32px; }

        // PIN dots
        HorizontalLayout {
            alignment: center;
            spacing: 16px;

            for i in 6: Rectangle {
                width: 16px;
                height: 16px;
                border-radius: 8px;
                background: i < pin-length ? Theme.primary : Theme.surface-variant;
            }
        }

        // Error message
        if error-message != "": Text {
            text: error-message;
            color: Theme.error;
            font-size: 14px;
            horizontal-alignment: center;
        }

        Rectangle { height: 16px; }

        // PIN pad - centered
        HorizontalLayout {
            alignment: center;
            PinPad {
                digit-pressed(d) => { root.digit-pressed(d); }
                backspace-pressed => { root.backspace-pressed(); }
            }
        }
    }
}

// Home screen with app grid - 4 columns, flexible layout
component HomeScreen inherits Rectangle {
    in property <[AppCategory]> categories: [];
    in property <string> time: "12:00";
    in property <int> battery: 85;
    in property <bool> wiggle-mode: false;
    in property <float> wiggle-time: 0;  // Time value for wiggle animation (set from Rust)
    in property <int> dragging-index: -1;  // Index of tile being dragged, -1 if none
    in property <float> drag-x: 0;  // Drag position X (screen coordinates)
    in property <float> drag-y: 0;  // Drag position Y (screen coordinates)

    callback app-tapped(int);
    callback drag-started(int, float, float);  // index, x, y
    callback drag-moved(int, float, float);    // index, x, y
    callback drag-ended(int, float, float);    // index, x, y

    width: 100%;
    height: 100%;
    background: Theme.background;

    VerticalLayout {
        StatusBar {
            time: root.time;
            battery: root.battery;
            wifi: true;
        }

        // App grid area - fills remaining space
        Rectangle {
            vertical-stretch: 1;
            background: Theme.background;

            VerticalLayout {
                padding: 24px;
                spacing: 16px;
                alignment: start;

                // Row 0 (items 0-3)
                if categories.length > 0: HorizontalLayout {
                    spacing: 12px;
                    height: 140px;

                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 0: AppTile {
                            name: categories[0].name;
                            icon: categories[0].icon;
                            tile-color: categories[0].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 0;
                            is-dragging: root.dragging-index == 0;
                            clicked => { app-tapped(0); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 1: AppTile {
                            name: categories[1].name;
                            icon: categories[1].icon;
                            tile-color: categories[1].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 1;
                            is-dragging: root.dragging-index == 1;
                            clicked => { app-tapped(1); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 2: AppTile {
                            name: categories[2].name;
                            icon: categories[2].icon;
                            tile-color: categories[2].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 2;
                            is-dragging: root.dragging-index == 2;
                            clicked => { app-tapped(2); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 3: AppTile {
                            name: categories[3].name;
                            icon: categories[3].icon;
                            tile-color: categories[3].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 3;
                            is-dragging: root.dragging-index == 3;
                            clicked => { app-tapped(3); }
                        }
                    }
                }

                // Row 1 (items 4-7)
                if categories.length > 4: HorizontalLayout {
                    spacing: 12px;
                    height: 140px;

                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 4: AppTile {
                            name: categories[4].name;
                            icon: categories[4].icon;
                            tile-color: categories[4].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 4;
                            is-dragging: root.dragging-index == 4;
                            clicked => { app-tapped(4); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 5: AppTile {
                            name: categories[5].name;
                            icon: categories[5].icon;
                            tile-color: categories[5].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 5;
                            is-dragging: root.dragging-index == 5;
                            clicked => { app-tapped(5); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 6: AppTile {
                            name: categories[6].name;
                            icon: categories[6].icon;
                            tile-color: categories[6].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 6;
                            is-dragging: root.dragging-index == 6;
                            clicked => { app-tapped(6); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 7: AppTile {
                            name: categories[7].name;
                            icon: categories[7].icon;
                            tile-color: categories[7].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 7;
                            is-dragging: root.dragging-index == 7;
                            clicked => { app-tapped(7); }
                        }
                    }
                }

                // Row 2 (items 8-11)
                if categories.length > 8: HorizontalLayout {
                    spacing: 12px;
                    height: 140px;

                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 8: AppTile {
                            name: categories[8].name;
                            icon: categories[8].icon;
                            tile-color: categories[8].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 8;
                            is-dragging: root.dragging-index == 8;
                            clicked => { app-tapped(8); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 9: AppTile {
                            name: categories[9].name;
                            icon: categories[9].icon;
                            tile-color: categories[9].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 9;
                            is-dragging: root.dragging-index == 9;
                            clicked => { app-tapped(9); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 10: AppTile {
                            name: categories[10].name;
                            icon: categories[10].icon;
                            tile-color: categories[10].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 10;
                            is-dragging: root.dragging-index == 10;
                            clicked => { app-tapped(10); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 11: AppTile {
                            name: categories[11].name;
                            icon: categories[11].icon;
                            tile-color: categories[11].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 11;
                            is-dragging: root.dragging-index == 11;
                            clicked => { app-tapped(11); }
                        }
                    }
                }

                // Row 3 (items 12-15)
                if categories.length > 12: HorizontalLayout {
                    spacing: 12px;
                    height: 140px;

                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 12: AppTile {
                            name: categories[12].name;
                            icon: categories[12].icon;
                            tile-color: categories[12].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 12;
                            is-dragging: root.dragging-index == 12;
                            clicked => { app-tapped(12); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 13: AppTile {
                            name: categories[13].name;
                            icon: categories[13].icon;
                            tile-color: categories[13].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 13;
                            is-dragging: root.dragging-index == 13;
                            clicked => { app-tapped(13); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 14: AppTile {
                            name: categories[14].name;
                            icon: categories[14].icon;
                            tile-color: categories[14].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 14;
                            is-dragging: root.dragging-index == 14;
                            clicked => { app-tapped(14); }
                        }
                    }
                    Rectangle {
                        horizontal-stretch: 1;
                        if categories.length > 15: AppTile {
                            name: categories[15].name;
                            icon: categories[15].icon;
                            tile-color: categories[15].color;
                            wiggling: root.wiggle-mode;
                            wiggle-time: root.wiggle-time;
                            wiggle-phase: 15;
                            is-dragging: root.dragging-index == 15;
                            clicked => { app-tapped(15); }
                        }
                    }
                }

                // Spacer at bottom
                Rectangle { vertical-stretch: 1; }
            }
        }

        HomeIndicator {}
    }

    // Floating dragged tile overlay - shows when dragging an icon
    if dragging-index >= 0 && dragging-index < categories.length: Rectangle {
        x: drag-x * 1px - 50px;  // Center the 100px wide tile on the finger
        y: drag-y * 1px - 70px;  // Offset up slightly so finger doesn't cover it
        width: 100px;
        height: 130px;
        background: transparent;

        // The tile icon
        Rectangle {
            x: 10px;
            y: 0;
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: categories[dragging-index].color;
            opacity: 0.9;

            Text {
                width: 100%;
                height: 100%;
                text: categories[dragging-index].icon;
                color: Theme.on-surface;
                font-size: 36px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Name label
        Text {
            x: 0;
            y: 90px;
            width: 100%;
            height: 30px;
            text: categories[dragging-index].name;
            color: Theme.on-surface;
            font-size: 14px;
            horizontal-alignment: center;
            overflow: elide;
        }
    }
}

// Quick settings panel - comprehensive iOS/Android-style control center
component QuickSettingsPanel inherits Rectangle {
    in property <float> brightness: 0.7;
    in property <bool> wifi-enabled: true;
    in property <bool> bluetooth-enabled: false;
    in property <bool> dnd-enabled: false;
    in property <bool> flashlight-enabled: false;
    in property <bool> airplane-enabled: false;
    in property <bool> rotation-locked: false;
    in property <string> wifi-ssid: "Home WiFi";
    in property <int> battery-percent: 85;
    in property <string> time: "12:00";
    in property <[Notification]> notifications: [];

    callback brightness-changed(float);
    callback wifi-toggled();
    callback bluetooth-toggled();
    callback dnd-toggled();
    callback flashlight-toggled();
    callback airplane-toggled();
    callback rotation-toggled();
    callback lock-pressed();
    callback settings-pressed();
    callback notification-dismissed(int);
    callback notification-tapped(int);
    callback clear-all-notifications();

    width: 100%;
    height: 100%;
    background: Theme.background;

    VerticalLayout {
        padding: 0px;
        spacing: 1px;

        // Header with time and status
        Rectangle {
            height: 72px;
            background: Theme.surface;

            HorizontalLayout {
                padding-left: 20px;
                padding-right: 20px;
                padding-top: 16px;
                padding-bottom: 16px;
                spacing: 16px;

                Text {
                    text: time;
                    color: Theme.on-surface;
                    font-size: 32px;
                    font-weight: 300;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                VerticalLayout {
                    alignment: center;
                    spacing: 2px;

                    HorizontalLayout {
                        spacing: 8px;
                        alignment: end;

                        // WiFi indicator
                        Text {
                            text: wifi-enabled ? "W" : "";
                            color: Theme.primary;
                            font-size: 12px;
                        }
                        // Bluetooth indicator
                        Text {
                            text: bluetooth-enabled ? "B" : "";
                            color: Theme.primary;
                            font-size: 12px;
                        }
                        // DND indicator
                        Text {
                            text: dnd-enabled ? "ðŸŒ™" : "";
                            font-size: 12px;
                        }
                    }

                    Text {
                        text: battery-percent + "%";
                        color: battery-percent > 20 ? Theme.on-surface : Theme.error;
                        font-size: 14px;
                        font-weight: 500;
                        horizontal-alignment: right;
                    }
                }
            }
        }

        // Quick toggles - 2 rows of 4
        Rectangle {
            height: 200px;
            background: Theme.surface;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;

                // Row 1
                HorizontalLayout {
                    spacing: 12px;
                    alignment: space-around;

                    QuickToggle {
                        label: "WiFi";
                        icon: "W";
                        enabled: wifi-enabled;
                        toggled => { wifi-toggled(); }
                    }

                    QuickToggle {
                        label: "Bluetooth";
                        icon: "B";
                        enabled: bluetooth-enabled;
                        toggled => { bluetooth-toggled(); }
                    }

                    QuickToggle {
                        label: "DND";
                        icon: "ðŸŒ™";
                        enabled: dnd-enabled;
                        toggled => { dnd-toggled(); }
                    }

                    QuickToggle {
                        label: "Flash";
                        icon: "ðŸ”¦";
                        enabled: flashlight-enabled;
                        toggled => { flashlight-toggled(); }
                    }
                }

                // Row 2
                HorizontalLayout {
                    spacing: 12px;
                    alignment: space-around;

                    QuickToggle {
                        label: "Airplane";
                        icon: "âœˆ";
                        enabled: airplane-enabled;
                        toggled => { airplane-toggled(); }
                    }

                    QuickToggle {
                        label: "Rotate";
                        icon: "ðŸ”„";
                        enabled: rotation-locked;
                        toggled => { rotation-toggled(); }
                    }

                    QuickToggle {
                        label: "Lock";
                        icon: "ðŸ”’";
                        enabled: false;
                        toggled => { lock-pressed(); }
                    }

                    QuickToggle {
                        label: "Settings";
                        icon: "âš™";
                        enabled: false;
                        toggled => { settings-pressed(); }
                    }
                }
            }
        }

        // Brightness slider
        Rectangle {
            height: 70px;
            background: Theme.surface;

            HorizontalLayout {
                padding: 16px;
                spacing: 12px;

                Text {
                    text: "â˜€";
                    color: Theme.on-surface-variant;
                    font-size: 18px;
                    vertical-alignment: center;
                }

                BrightnessSlider {
                    horizontal-stretch: 1;
                    value: brightness;
                    changed(v) => { brightness-changed(v); }
                }

                Text {
                    text: "â˜€";
                    color: Theme.on-surface;
                    font-size: 22px;
                    vertical-alignment: center;
                }
            }
        }

        // Notifications section
        Rectangle {
            vertical-stretch: 1;
            background: Theme.background;

            VerticalLayout {
                padding: 16px;
                spacing: 8px;

                // Notifications header
                HorizontalLayout {
                    height: 30px;

                    Text {
                        text: "Notifications";
                        color: Theme.on-surface;
                        font-size: 14px;
                        font-weight: 600;
                        vertical-alignment: center;
                        horizontal-stretch: 1;
                    }

                    Rectangle {
                        width: 80px;
                        height: 28px;
                        border-radius: 14px;
                        background: notifications.length > 0 ? Theme.surface-variant : transparent;
                        visible: notifications.length > 0;

                        Text {
                            text: "Clear all";
                            color: Theme.primary;
                            font-size: 11px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            clicked => { clear-all-notifications(); }
                        }
                    }
                }

                // Notification list or empty state
                if notifications.length == 0: Rectangle {
                    vertical-stretch: 1;

                    VerticalLayout {
                        alignment: center;
                        spacing: 8px;

                        Text {
                            text: "ðŸ””";
                            font-size: 48px;
                            horizontal-alignment: center;
                        }

                        Text {
                            text: "No notifications";
                            color: Theme.on-surface-variant;
                            font-size: 14px;
                            horizontal-alignment: center;
                        }

                        Text {
                            text: "You're all caught up!";
                            color: Theme.on-surface-variant.with-alpha(0.6);
                            font-size: 12px;
                            horizontal-alignment: center;
                        }
                    }
                }

                // Notification cards
                for notification[idx] in notifications: NotificationCard {
                    app-name: notification.app-name;
                    app-icon: notification.app-icon;
                    title: notification.title;
                    body: notification.body;
                    time: notification.time;
                    urgency: notification.urgency;
                    dismissed => { notification-dismissed(notification.id); }
                    tapped => { notification-tapped(notification.id); }
                }
            }
        }

        HomeIndicator {}
    }
}

// On-Screen Keyboard Key - scales to fill available space
component KeyboardKey inherits Rectangle {
    in property <string> label: "";
    in property <string> shift-label: "";  // Label when shift is active
    in property <bool> shifted: false;
    in property <float> width-factor: 1.0;  // 1.0 = normal, 1.5 = 1.5x width, etc.
    in property <bool> is-special: false;  // Special keys (shift, backspace, etc.)
    in property <bool> is-active: false;  // For toggle keys like shift

    callback pressed();

    // Use stretch to fill available space proportionally
    horizontal-stretch: width-factor;
    vertical-stretch: 1;
    border-radius: 6px;
    background: touch.pressed ? Theme.primary : (is-special ? (is-active ? Theme.primary-container : #2a2a3a) : Theme.surface-variant);

    Text {
        width: 100%;
        height: 100%;
        text: root.shifted && root.shift-label != "" ? root.shift-label : root.label;
        color: Theme.on-surface;
        font-size: is-special ? 12px : 16px;
        horizontal-alignment: center;
        vertical-alignment: center;
    }

    touch := TouchArea {
        clicked => { root.pressed(); }
    }
}

// On-Screen Keyboard - scales to fill available space
component OnScreenKeyboard inherits Rectangle {
    in property <bool> shifted: false;
    in property <bool> caps-lock: false;
    in property <int> layout: 0;  // 0 = letters, 1 = numbers/symbols
    in property <length> container-height: 720px;  // Parent height passed in

    callback key-pressed(string);  // The character or key name
    callback shift-toggled();
    callback caps-toggled();
    callback backspace-pressed();
    callback enter-pressed();
    callback space-pressed();
    callback layout-toggled();  // Switch between letters and symbols
    callback hide-keyboard();

    width: 100%;
    // Height is ~22% of screen height, minimum 200px for usability
    height: max(200px, container-height * 0.22);
    background: Theme.background;

    property <bool> show-shift: shifted || caps-lock;

    VerticalLayout {
        width: 100%;
        height: 100%;
        padding: 6px;
        spacing: 6px;

        // Row 1: q w e r t y u i o p (or 1 2 3 4 5 6 7 8 9 0)
        HorizontalLayout {
            spacing: 4px;
            vertical-stretch: 1;

            if layout == 0: KeyboardKey { label: "q"; shift-label: "Q"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Q" : "q"); } }
            if layout == 0: KeyboardKey { label: "w"; shift-label: "W"; shifted: show-shift; pressed => { key-pressed(show-shift ? "W" : "w"); } }
            if layout == 0: KeyboardKey { label: "e"; shift-label: "E"; shifted: show-shift; pressed => { key-pressed(show-shift ? "E" : "e"); } }
            if layout == 0: KeyboardKey { label: "r"; shift-label: "R"; shifted: show-shift; pressed => { key-pressed(show-shift ? "R" : "r"); } }
            if layout == 0: KeyboardKey { label: "t"; shift-label: "T"; shifted: show-shift; pressed => { key-pressed(show-shift ? "T" : "t"); } }
            if layout == 0: KeyboardKey { label: "y"; shift-label: "Y"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Y" : "y"); } }
            if layout == 0: KeyboardKey { label: "u"; shift-label: "U"; shifted: show-shift; pressed => { key-pressed(show-shift ? "U" : "u"); } }
            if layout == 0: KeyboardKey { label: "i"; shift-label: "I"; shifted: show-shift; pressed => { key-pressed(show-shift ? "I" : "i"); } }
            if layout == 0: KeyboardKey { label: "o"; shift-label: "O"; shifted: show-shift; pressed => { key-pressed(show-shift ? "O" : "o"); } }
            if layout == 0: KeyboardKey { label: "p"; shift-label: "P"; shifted: show-shift; pressed => { key-pressed(show-shift ? "P" : "p"); } }

            if layout == 1: KeyboardKey { label: "1"; shift-label: "!"; shifted: show-shift; pressed => { key-pressed(show-shift ? "!" : "1"); } }
            if layout == 1: KeyboardKey { label: "2"; shift-label: "@"; shifted: show-shift; pressed => { key-pressed(show-shift ? "@" : "2"); } }
            if layout == 1: KeyboardKey { label: "3"; shift-label: "#"; shifted: show-shift; pressed => { key-pressed(show-shift ? "#" : "3"); } }
            if layout == 1: KeyboardKey { label: "4"; shift-label: "$"; shifted: show-shift; pressed => { key-pressed(show-shift ? "$" : "4"); } }
            if layout == 1: KeyboardKey { label: "5"; shift-label: "%"; shifted: show-shift; pressed => { key-pressed(show-shift ? "%" : "5"); } }
            if layout == 1: KeyboardKey { label: "6"; shift-label: "^"; shifted: show-shift; pressed => { key-pressed(show-shift ? "^" : "6"); } }
            if layout == 1: KeyboardKey { label: "7"; shift-label: "&"; shifted: show-shift; pressed => { key-pressed(show-shift ? "&" : "7"); } }
            if layout == 1: KeyboardKey { label: "8"; shift-label: "*"; shifted: show-shift; pressed => { key-pressed(show-shift ? "*" : "8"); } }
            if layout == 1: KeyboardKey { label: "9"; shift-label: "("; shifted: show-shift; pressed => { key-pressed(show-shift ? "(" : "9"); } }
            if layout == 1: KeyboardKey { label: "0"; shift-label: ")"; shifted: show-shift; pressed => { key-pressed(show-shift ? ")" : "0"); } }
        }

        // Row 2: a s d f g h j k l (or symbols)
        HorizontalLayout {
            spacing: 4px;
            vertical-stretch: 1;

            if layout == 0: KeyboardKey { label: "a"; shift-label: "A"; shifted: show-shift; pressed => { key-pressed(show-shift ? "A" : "a"); } }
            if layout == 0: KeyboardKey { label: "s"; shift-label: "S"; shifted: show-shift; pressed => { key-pressed(show-shift ? "S" : "s"); } }
            if layout == 0: KeyboardKey { label: "d"; shift-label: "D"; shifted: show-shift; pressed => { key-pressed(show-shift ? "D" : "d"); } }
            if layout == 0: KeyboardKey { label: "f"; shift-label: "F"; shifted: show-shift; pressed => { key-pressed(show-shift ? "F" : "f"); } }
            if layout == 0: KeyboardKey { label: "g"; shift-label: "G"; shifted: show-shift; pressed => { key-pressed(show-shift ? "G" : "g"); } }
            if layout == 0: KeyboardKey { label: "h"; shift-label: "H"; shifted: show-shift; pressed => { key-pressed(show-shift ? "H" : "h"); } }
            if layout == 0: KeyboardKey { label: "j"; shift-label: "J"; shifted: show-shift; pressed => { key-pressed(show-shift ? "J" : "j"); } }
            if layout == 0: KeyboardKey { label: "k"; shift-label: "K"; shifted: show-shift; pressed => { key-pressed(show-shift ? "K" : "k"); } }
            if layout == 0: KeyboardKey { label: "l"; shift-label: "L"; shifted: show-shift; pressed => { key-pressed(show-shift ? "L" : "l"); } }

            if layout == 1: KeyboardKey { label: "-"; shift-label: "_"; shifted: show-shift; pressed => { key-pressed(show-shift ? "_" : "-"); } }
            if layout == 1: KeyboardKey { label: "="; shift-label: "+"; shifted: show-shift; pressed => { key-pressed(show-shift ? "+" : "="); } }
            if layout == 1: KeyboardKey { label: "["; shift-label: "{"; shifted: show-shift; pressed => { key-pressed(show-shift ? "{" : "["); } }
            if layout == 1: KeyboardKey { label: "]"; shift-label: "}"; shifted: show-shift; pressed => { key-pressed(show-shift ? "}" : "]"); } }
            if layout == 1: KeyboardKey { label: "\\"; shift-label: "|"; shifted: show-shift; pressed => { key-pressed(show-shift ? "|" : "\\"); } }
            if layout == 1: KeyboardKey { label: ";"; shift-label: ":"; shifted: show-shift; pressed => { key-pressed(show-shift ? ":" : ";"); } }
            if layout == 1: KeyboardKey { label: "'"; shift-label: "\""; shifted: show-shift; pressed => { key-pressed(show-shift ? "\"" : "'"); } }
            if layout == 1: KeyboardKey { label: ","; shift-label: "<"; shifted: show-shift; pressed => { key-pressed(show-shift ? "<" : ","); } }
            if layout == 1: KeyboardKey { label: "."; shift-label: ">"; shifted: show-shift; pressed => { key-pressed(show-shift ? ">" : "."); } }
        }

        // Row 3: shift z x c v b n m backspace
        HorizontalLayout {
            spacing: 4px;
            vertical-stretch: 1;

            KeyboardKey {
                label: "SHIFT";
                width-factor: 1.5;
                is-special: true;
                is-active: show-shift;
                pressed => { shift-toggled(); }
            }

            if layout == 0: KeyboardKey { label: "z"; shift-label: "Z"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Z" : "z"); } }
            if layout == 0: KeyboardKey { label: "x"; shift-label: "X"; shifted: show-shift; pressed => { key-pressed(show-shift ? "X" : "x"); } }
            if layout == 0: KeyboardKey { label: "c"; shift-label: "C"; shifted: show-shift; pressed => { key-pressed(show-shift ? "C" : "c"); } }
            if layout == 0: KeyboardKey { label: "v"; shift-label: "V"; shifted: show-shift; pressed => { key-pressed(show-shift ? "V" : "v"); } }
            if layout == 0: KeyboardKey { label: "b"; shift-label: "B"; shifted: show-shift; pressed => { key-pressed(show-shift ? "B" : "b"); } }
            if layout == 0: KeyboardKey { label: "n"; shift-label: "N"; shifted: show-shift; pressed => { key-pressed(show-shift ? "N" : "n"); } }
            if layout == 0: KeyboardKey { label: "m"; shift-label: "M"; shifted: show-shift; pressed => { key-pressed(show-shift ? "M" : "m"); } }

            if layout == 1: KeyboardKey { label: "/"; shift-label: "?"; shifted: show-shift; pressed => { key-pressed(show-shift ? "?" : "/"); } }
            if layout == 1: KeyboardKey { label: "`"; shift-label: "~"; shifted: show-shift; pressed => { key-pressed(show-shift ? "~" : "`"); } }
            if layout == 1: KeyboardKey { label: "@"; pressed => { key-pressed("@"); } }
            if layout == 1: KeyboardKey { label: "#"; pressed => { key-pressed("#"); } }
            if layout == 1: KeyboardKey { label: "&"; pressed => { key-pressed("&"); } }
            if layout == 1: KeyboardKey { label: "*"; pressed => { key-pressed("*"); } }
            if layout == 1: KeyboardKey { label: "("; pressed => { key-pressed("("); } }

            KeyboardKey {
                label: "DEL";
                width-factor: 1.5;
                is-special: true;
                pressed => { backspace-pressed(); }
            }
        }

        // Row 4: 123/ABC space . enter
        HorizontalLayout {
            spacing: 4px;
            vertical-stretch: 1;

            KeyboardKey {
                label: layout == 0 ? "123" : "ABC";
                width-factor: 1.5;
                is-special: true;
                pressed => { layout-toggled(); }
            }

            KeyboardKey { label: ","; pressed => { key-pressed(","); } }

            KeyboardKey {
                label: "SPACE";
                width-factor: 5.0;
                is-special: true;
                pressed => { space-pressed(); }
            }

            KeyboardKey { label: "."; pressed => { key-pressed("."); } }

            KeyboardKey {
                label: "ENTER";
                width-factor: 1.5;
                is-special: true;
                pressed => { enter-pressed(); }
            }
        }

        // Hide keyboard button row (smaller than other rows)
        HorizontalLayout {
            spacing: 4px;
            vertical-stretch: 0.6;

            KeyboardKey {
                label: "âŒ¨ HIDE";
                width-factor: 3.0;
                is-special: true;
                pressed => { hide-keyboard(); }
            }
        }
    }
}

// App Switcher panel - stacked card layout (cards rendered by compositor)
component AppSwitcherPanel inherits Rectangle {
    in property <[WindowCard]> windows: [];
    in property <float> scroll-offset: 0;  // Horizontal scroll position (for sync)

    callback window-tapped(int);  // Window ID
    callback close-requested();   // Swipe down to close

    width: 100%;
    height: 100%;
    background: Theme.background;

    VerticalLayout {
        // Header bar
        Rectangle {
            height: 60px;
            background: #26263a;

            Text {
                width: 100%;
                height: 100%;
                text: "RECENT APPS";
                color: Theme.on-surface;
                font-size: 18px;
                font-weight: 600;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Card area - compositor renders stacked cards on top
        Rectangle {
            vertical-stretch: 1;
            background: Theme.background;

            // Empty state
            if windows.length == 0: Rectangle {
                width: 100%;
                height: 100%;

                Text {
                    width: 100%;
                    height: 100%;
                    text: "NO APPS";
                    color: #9999aa;
                    font-size: 32px;
                    font-weight: 600;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            // Card backgrounds and window previews are rendered by the compositor
            // with dynamic sizing based on scroll position (stacked Android-style layout)
        }

        HomeIndicator {}
    }
}

// Main shell component
export component FlickShell inherits Window {
    in property <string> current-view: "lock"; // "lock", "home", "quick-settings", "pick-default"
    in property <[AppCategory]> categories: [];
    in property <string> lock-time: "12:00";
    in property <string> lock-date: "Saturday, December 7";
    in property <int> pin-length: 0;
    in property <string> lock-error: "";
    in property <float> brightness: 0.7;
    in property <bool> wifi-enabled: true;
    in property <bool> bluetooth-enabled: false;
    in property <bool> dnd-enabled: false;
    in property <bool> flashlight-enabled: false;
    in property <bool> airplane-enabled: false;
    in property <bool> rotation-locked: false;
    in property <string> wifi-ssid: "WiFi";
    in property <int> battery-percent: 85;
    in property <[Notification]> notifications: [];

    // Popup menu state
    in property <bool> show-popup: false;
    in property <string> popup-category-name: "";
    in property <bool> popup-can-pick-default: true;
    in property <float> popup-x: 100;
    in property <float> popup-y: 200;

    // Wiggle mode state
    in property <bool> wiggle-mode: false;
    in property <float> wiggle-time: 0;  // Time value for wiggle animation (set from Rust)
    in property <int> dragging-index: -1;  // Index of tile being dragged, -1 if none
    in property <float> drag-x: 0;  // Drag position X (screen coordinates)
    in property <float> drag-y: 0;  // Drag position Y (screen coordinates)

    // Pick default view state
    in property <string> pick-default-category: "";
    in property <[AvailableApp]> available-apps: [];
    in property <string> current-app-selection: "";

    // App switcher state
    in property <[WindowCard]> switcher-windows: [];
    in property <float> switcher-scroll: 0;

    // Keyboard state
    in property <bool> keyboard-visible: false;
    in property <bool> keyboard-shifted: false;
    in property <bool> keyboard-caps-lock: false;
    in property <int> keyboard-layout: 0;  // 0 = letters, 1 = numbers/symbols

    callback pin-digit-pressed(string);
    callback pin-backspace-pressed();
    callback pin-enter-pressed();
    callback app-tapped(int);
    callback app-long-pressed(int);
    callback brightness-changed(float);
    callback wifi-toggled();
    callback bluetooth-toggled();
    callback dnd-toggled();
    callback flashlight-toggled();
    callback airplane-toggled();
    callback rotation-toggled();
    callback lock-pressed();
    callback settings-pressed();
    callback notification-dismissed(int);
    callback notification-tapped(int);
    callback clear-all-notifications();

    // Callbacks for popup menu actions
    callback popup-pick-default();
    callback popup-move();
    callback popup-close();
    callback wiggle-done();
    callback pick-default-selected(string);  // exec command
    callback pick-default-back();
    callback switcher-window-tapped(int);  // Window ID

    // Keyboard callbacks
    callback keyboard-key-pressed(string);  // Character pressed
    callback keyboard-backspace();
    callback keyboard-enter();
    callback keyboard-space();
    callback keyboard-shift-toggled();
    callback keyboard-layout-toggled();
    callback keyboard-hide();

    title: "Flick Shell";
    // Transparent background when in app view (keyboard only), otherwise dark
    // Use explicit #00000000 for full transparency
    background: current-view == "app" ? #00000000 : #1a1a2e;

    // Home screen - visible except in app view (where we only show keyboard overlay)
    if current-view != "app": HomeScreen {
        width: 100%;
        height: 100%;
        categories: categories;
        time: lock-time;
        battery: battery-percent;
        wiggle-mode: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        dragging-index: root.dragging-index;
        drag-x: root.drag-x;
        drag-y: root.drag-y;
        app-tapped(i) => { app-tapped(i); }
    }

    // Quick settings - slides down as overlay on top of home
    QuickSettingsPanel {
        y: current-view == "quick-settings" ? 0px : -parent.height;
        width: 100%;
        height: 100%;
        brightness: brightness;
        wifi-enabled: wifi-enabled;
        bluetooth-enabled: bluetooth-enabled;
        dnd-enabled: dnd-enabled;
        flashlight-enabled: flashlight-enabled;
        airplane-enabled: airplane-enabled;
        rotation-locked: rotation-locked;
        wifi-ssid: wifi-ssid;
        battery-percent: battery-percent;
        notifications: notifications;
        time: lock-time;
        brightness-changed(v) => { brightness-changed(v); }
        wifi-toggled => { wifi-toggled(); }
        bluetooth-toggled => { bluetooth-toggled(); }
        dnd-toggled => { dnd-toggled(); }
        flashlight-toggled => { flashlight-toggled(); }
        airplane-toggled => { airplane-toggled(); }
        rotation-toggled => { rotation-toggled(); }
        lock-pressed => { lock-pressed(); }
        settings-pressed => { settings-pressed(); }
        notification-dismissed(id) => { notification-dismissed(id); }
        notification-tapped(id) => { notification-tapped(id); }
        clear-all-notifications => { clear-all-notifications(); }
    }

    // App Switcher - slides in from right edge
    AppSwitcherPanel {
        x: current-view == "switcher" ? 0px : parent.width;
        width: 100%;
        height: 100%;
        windows: switcher-windows;
        scroll-offset: switcher-scroll;
        window-tapped(id) => { switcher-window-tapped(id); }
    }

    // Lock screen - overlay on top of everything when locked
    LockScreen {
        y: current-view == "lock" ? 0px : -parent.height;
        width: 100%;
        height: 100%;
        time: lock-time;
        date: lock-date;
        pin-length: pin-length;
        error-message: lock-error;
        digit-pressed(d) => { pin-digit-pressed(d); }
        backspace-pressed => { pin-backspace-pressed(); }
    }

    // Pick default app view
    if current-view == "pick-default": PickDefaultView {
        width: 100%;
        height: 100%;
        category-name: pick-default-category;
        available-apps: available-apps;
        current-selection: current-app-selection;
        app-selected(exec) => { pick-default-selected(exec); }
        back-pressed => { pick-default-back(); }
    }

    // Popup menu overlay (shown on top of home when long press)
    if show-popup && current-view == "home": Rectangle {
        width: 100%;
        height: 100%;
        background: #00000088;

        // Dismiss when tapping outside
        TouchArea {
            clicked => { popup-close(); }
        }

        // Centered popup
        LongPressPopup {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            category-name: popup-category-name;
            can-pick-default: popup-can-pick-default;
            pick-default-clicked => { popup-pick-default(); }
            move-clicked => { popup-move(); }
            close-clicked => { popup-close(); }
        }
    }

    // Wiggle mode done button (shown at bottom when in wiggle mode)
    if wiggle-mode && current-view == "home": Rectangle {
        x: (parent.width - 200px) / 2;
        y: parent.height - 100px;
        width: 200px;
        height: 56px;

        WiggleDoneButton {
            width: 100%;
            height: 100%;
            clicked => { wiggle-done(); }
        }
    }

    // On-screen keyboard - slides up from bottom
    OnScreenKeyboard {
        y: keyboard-visible ? parent.height - self.height : parent.height;
        width: 100%;
        container-height: parent.height;
        shifted: keyboard-shifted;
        caps-lock: keyboard-caps-lock;
        layout: keyboard-layout;
        key-pressed(ch) => { keyboard-key-pressed(ch); }
        shift-toggled => { keyboard-shift-toggled(); }
        backspace-pressed => { keyboard-backspace(); }
        enter-pressed => { keyboard-enter(); }
        space-pressed => { keyboard-space(); }
        layout-toggled => { keyboard-layout-toggled(); }
        hide-keyboard => { keyboard-hide(); }
    }
}
