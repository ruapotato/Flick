// Flick Shell UI - Mobile-first Linux shell
// Uses Slint declarative UI with Material Design inspired styling

import { Button, VerticalBox, HorizontalBox, GridBox, ScrollView } from "std-widgets.slint";

// Color scheme - dark mobile theme with accent
global Theme {
    out property <color> background: #0a0a0f;
    out property <color> surface: #12121a;
    out property <color> surface-variant: #1a1a24;
    out property <color> primary: #4a9eff;
    out property <color> primary-container: #1a3a5c;
    out property <color> accent: #e94560;
    out property <color> accent-dim: #c23a50;
    out property <color> on-surface: #ffffff;
    out property <color> on-surface-variant: #888899;
    out property <color> error: #ff6b6b;
    out property <color> success: #4ade80;
}

// Simple brightness slider (custom, software renderer compatible)
component BrightnessSlider inherits Rectangle {
    in property <float> value: 0.5;  // 0.0 to 1.0
    callback changed(float);

    height: 32px;
    background: transparent;

    // Track background
    Rectangle {
        x: 0px;
        y: (parent.height - 6px) / 2;
        width: parent.width;
        height: 6px;
        border-radius: 3px;
        background: #1a1a24;

        // Filled portion with gradient
        Rectangle {
            width: parent.width * root.value;
            height: 100%;
            border-radius: 3px;
            background: Theme.accent;
        }
    }

    // Thumb
    Rectangle {
        x: (parent.width - 24px) * root.value;
        y: (parent.height - 24px) / 2;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        background: Theme.accent;

        // Inner dot
        Rectangle {
            x: (parent.width - 10px) / 2;
            y: (parent.height - 10px) / 2;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background: #ffffff;
        }
    }

    touch := TouchArea {
        moved => {
            if self.pressed {
                root.changed(max(0.0, min(1.0, self.mouse-x / parent.width)));
            }
        }
        clicked => {
            root.changed(max(0.0, min(1.0, self.mouse-x / parent.width)));
        }
    }
}

// Volume slider with percentage display
component VolumeSlider inherits Rectangle {
    in property <int> value: 50;  // 0 to 100
    in property <bool> muted: false;
    callback changed(int);

    height: 32px;
    background: transparent;

    // Track background
    Rectangle {
        x: 0px;
        y: (parent.height - 6px) / 2;
        width: parent.width;
        height: 6px;
        border-radius: 3px;
        background: #1a1a24;

        // Filled portion
        Rectangle {
            width: root.muted ? 0px : parent.width * (root.value / 100.0);
            height: 100%;
            border-radius: 3px;
            background: root.muted ? Theme.on-surface-variant : Theme.accent;
        }
    }

    // Thumb
    Rectangle {
        x: (parent.width - 24px) * (root.value / 100.0);
        y: (parent.height - 24px) / 2;
        width: 24px;
        height: 24px;
        border-radius: 12px;
        background: root.muted ? Theme.on-surface-variant : Theme.accent;

        // Inner dot
        Rectangle {
            x: (parent.width - 10px) / 2;
            y: (parent.height - 10px) / 2;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background: #ffffff;
        }
    }

    touch := TouchArea {
        moved => {
            if self.pressed {
                root.changed(max(0, min(100, round(self.mouse-x / parent.width * 100))));
            }
        }
        clicked => {
            root.changed(max(0, min(100, round(self.mouse-x / parent.width * 100))));
        }
    }
}

// Volume overlay component - shown briefly when hardware volume buttons pressed
component VolumeOverlay inherits Rectangle {
    in property <int> volume: 50;  // 0 to 100
    in property <bool> muted: false;

    width: 140px;
    height: 420px;
    background: #000000e8;
    border-radius: 28px;
    drop-shadow-color: #000000aa;
    drop-shadow-blur: 30px;
    drop-shadow-offset-y: 6px;

    // Subtle border
    Rectangle {
        width: 100%;
        height: 100%;
        border-radius: parent.border-radius;
        border-width: 1px;
        border-color: #ffffff20;
        background: transparent;
    }

    VerticalLayout {
        alignment: center;
        padding: 24px;
        spacing: 20px;

        // Speaker icon with glow effect
        Rectangle {
            width: 72px;
            height: 72px;
            border-radius: 36px;
            background: root.muted ? #ff444430 : #60a0ff30;

            Text {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                text: root.muted ? "üîá" : (root.volume > 66 ? "üîä" : (root.volume > 33 ? "üîâ" : (root.volume > 0 ? "üîà" : "üîá")));
                font-size: 42px;
            }
        }

        // Vertical volume bar container
        Rectangle {
            width: 28px;
            height: 240px;
            background: #ffffff18;
            border-radius: 14px;

            // Track marks for visual feedback
            for i in [0, 25, 50, 75, 100]: Rectangle {
                y: parent.height - (parent.height * (i / 100.0)) - 1px;
                width: 100%;
                height: 2px;
                background: #ffffff15;
            }

            // Filled portion from bottom with gradient
            Rectangle {
                y: parent.height - self.height;
                width: 100%;
                height: root.muted ? 0px : parent.height * (root.volume / 100.0);
                border-radius: 14px;
                background: root.muted ? #ff4444 : (root.volume > 80 ? @linear-gradient(0deg, #60a0ff 0%, #80ff80 100%) : @linear-gradient(0deg, #4080e0 0%, #60a0ff 100%));

                // Glow at top
                Rectangle {
                    y: 0;
                    width: 100%;
                    height: min(30px, parent.height);
                    border-radius: 14px;
                    background: @linear-gradient(180deg, #ffffff40 0%, transparent 100%);
                }

                animate height { duration: 100ms; easing: ease-out; }
            }
        }

        // Volume percentage with subtle styling
        Rectangle {
            width: 72px;
            height: 36px;
            border-radius: 18px;
            background: #ffffff10;

            Text {
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                text: root.muted ? "OFF" : "\{root.volume}%";
                color: root.muted ? #ff6666 : #ffffff;
                font-size: 18px;
                font-weight: 600;
            }
        }
    }
}

// App category for home screen
export struct AppCategory {
    name: string,
    icon: image,
    color: color,
}

// Available app for picking default
export struct AvailableApp {
    name: string,
    exec: string,
}

// Notification data structure
export struct Notification {
    id: int,
    app-name: string,
    app-icon: string,
    title: string,
    body: string,
    time: string,
    urgency: int,  // 0=low, 1=normal, 2=critical
}

// Window card for app switcher
export struct WindowCard {
    id: int,
    title: string,
    app-class: string,
    original-index: int,  // Original index for positioning (render order may differ)
    preview: image,       // Screenshot of the app window
}

// UI icons for quick settings and other shell elements
export struct UiIcons {
    wifi: image,
    wifi-off: image,
    bluetooth: image,
    bluetooth-off: image,
    moon: image,
    flashlight: image,
    flashlight-off: image,
    plane: image,
    rotate: image,
    lock: image,
    sun: image,
    volume: image,
    volume-off: image,
    wand: image,
}

// Status bar at top of screen
component StatusBar inherits Rectangle {
    in property <string> time: "12:00";
    in property <int> battery: 85;
    in property <bool> wifi: true;
    in property <float> text-scale: 2.0;

    height: 54px * text-scale;
    background: transparent;

    HorizontalLayout {
        padding-left: 20px;
        padding-right: 20px;
        spacing: 12px;

        // Time (left) - base 54px (3x larger)
        Text {
            text: time;
            color: Theme.on-surface;
            font-size: 54px * text-scale;
            font-weight: 600;
            vertical-alignment: center;
        }

        Rectangle { horizontal-stretch: 1; }

        // Status icons (right)
        HorizontalLayout {
            spacing: 16px;

            // WiFi indicator
            Text {
                text: wifi ? "W" : "-";
                color: wifi ? Theme.primary : Theme.on-surface-variant;
                font-size: 48px * text-scale;
                font-weight: 500;
                vertical-alignment: center;
            }

            // Battery - base 54px (3x larger)
            Text {
                text: battery + "%";
                color: battery > 20 ? Theme.success : Theme.error;
                font-size: 54px * text-scale;
                font-weight: 600;
                vertical-alignment: center;
            }
        }
    }
}

// Home indicator at bottom
component HomeIndicator inherits Rectangle {
    height: 34px;
    background: transparent;

    Rectangle {
        x: (parent.width - self.width) / 2;
        y: 8px;
        width: 134px;
        height: 5px;
        border-radius: 2.5px;
        background: Theme.on-surface-variant.with-alpha(0.5);
    }
}

// Popup menu button
component PopupButton inherits Rectangle {
    in property <string> label: "Button";
    in property <bool> highlighted: false;

    callback clicked();

    height: 56px;
    background: touch.pressed ? Theme.primary-container : (highlighted ? Theme.surface-variant : transparent);
    border-radius: 12px;

    HorizontalLayout {
        padding-left: 20px;
        padding-right: 20px;

        Text {
            text: label;
            color: Theme.on-surface;
            font-size: 16px;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// Long press popup menu - shows "Pick Default" and "Move" options
component LongPressPopup inherits Rectangle {
    in property <string> category-name: "App";
    in property <bool> can-pick-default: true;  // Settings can't pick default

    callback pick-default-clicked();
    callback move-clicked();
    callback close-clicked();

    width: 280px;
    height: can-pick-default ? 180px : 130px;
    border-radius: 20px;
    background: Theme.surface;
    // Note: drop-shadow not supported in software renderer
    border-width: 1px;
    border-color: Theme.surface-variant;

    VerticalLayout {
        padding: 16px;
        spacing: 8px;

        // Title
        Text {
            text: category-name;
            color: Theme.on-surface;
            font-size: 18px;
            font-weight: 600;
            horizontal-alignment: center;
        }

        Rectangle { height: 8px; }

        // Pick Default button (only if customizable)
        if can-pick-default: PopupButton {
            label: "Pick Default App";
            clicked => { pick-default-clicked(); }
        }

        // Move button
        PopupButton {
            label: "Move Icon";
            clicked => { move-clicked(); }
        }
    }

    // Close when tapping outside (background touch area behind everything)
}

// Circular context menu for copy/paste - appears on long press
component CircularContextMenu inherits Rectangle {
    in property <float> center-x: 200;
    in property <float> center-y: 400;
    in property <int> highlighted-option: 0;  // 0=none, 1=copy, 2=paste, 3=system
    in property <string> clipboard-text: "";  // Current clipboard preview (unused now)

    // Menu dimensions - extra large buttons for easy touch
    property <length> button-size: 180px;
    property <length> button-distance: 200px;  // Distance from center
    property <length> system-bar-width: 200px;
    property <length> system-bar-height: 60px;

    width: 100%;
    height: 100%;
    background: transparent;

    // Hint text at TOP (above finger)
    Text {
        x: center-x * 1px - 300px;
        y: center-y * 1px - button-size / 2 - 100px;
        width: 600px;
        text: highlighted-option == 0 ? "‚Üê Copy    Paste ‚Üí" :
              highlighted-option == 1 ? "Release to copy selected text" :
              highlighted-option == 2 ? "Release to paste" :
              "Release for system menu";
        color: #ffffff;
        font-size: 28px;
        horizontal-alignment: center;
    }

    // Copy button (left side) - copies selected/highlighted text
    Rectangle {
        x: center-x * 1px - button-distance - button-size / 2;
        y: center-y * 1px - button-size / 2;
        width: button-size;
        height: button-size;
        border-radius: button-size / 2;
        background: highlighted-option == 1 ? #4a9eff : #1a1a24;
        border-width: 4px;
        border-color: highlighted-option == 1 ? #4a9eff : #333344;

        VerticalLayout {
            alignment: center;
            spacing: 12px;
            padding: 10px;
            Text {
                text: "üìã";
                font-size: 48px;
                horizontal-alignment: center;
            }
            Text {
                text: "Copy";
                color: #ffffff;
                font-size: 26px;
                horizontal-alignment: center;
            }
        }
    }

    // Paste button (right side)
    Rectangle {
        x: center-x * 1px + button-distance - button-size / 2;
        y: center-y * 1px - button-size / 2;
        width: button-size;
        height: button-size;
        border-radius: button-size / 2;
        background: highlighted-option == 2 ? #4a9eff : #1a1a24;
        border-width: 4px;
        border-color: highlighted-option == 2 ? #4a9eff : #333344;

        VerticalLayout {
            alignment: center;
            spacing: 12px;
            Text {
                text: "üìÑ";
                font-size: 48px;
                horizontal-alignment: center;
            }
            Text {
                text: "Paste";
                color: #ffffff;
                font-size: 26px;
                horizontal-alignment: center;
            }
        }
    }

    // System menu bar (bottom) - horizontal pill shape
    Rectangle {
        x: center-x * 1px - system-bar-width / 2;
        y: center-y * 1px + button-size / 2 + 40px;
        width: system-bar-width;
        height: system-bar-height;
        border-radius: system-bar-height / 2;
        background: highlighted-option == 3 ? #e94560 : #1a1a24;
        border-width: 3px;
        border-color: highlighted-option == 3 ? #e94560 : #333344;

        HorizontalLayout {
            alignment: center;
            spacing: 12px;
            Text {
                text: "‚öô";
                font-size: 28px;
                vertical-alignment: center;
            }
            Text {
                text: "System";
                color: #ffffff;
                font-size: 22px;
                vertical-alignment: center;
            }
        }
    }
}

// Copied popup notification - appears briefly when something is copied
component CopiedPopup inherits Rectangle {
    in property <float> pos-x: 200;
    in property <float> pos-y: 400;
    in property <string> copied-text: "";

    x: pos-x * 1px - 150px;
    y: pos-y * 1px - 80px;
    width: 300px;
    height: 70px;
    border-radius: 20px;
    background: #1a1a24ee;
    border-width: 2px;
    border-color: #4ade80;

    HorizontalLayout {
        alignment: center;
        spacing: 12px;
        padding: 12px;

        Text {
            text: "‚úì";
            color: #4ade80;
            font-size: 28px;
            vertical-alignment: center;
        }

        VerticalLayout {
            alignment: center;
            Text {
                text: "Copied!";
                color: #4ade80;
                font-size: 18px;
            }
            Text {
                text: copied-text;
                color: #cccccc;
                font-size: 14px;
                overflow: elide;
            }
        }
    }
}

// System menu - power options (lock, reboot, shutdown)
component SystemMenu inherits Rectangle {
    callback action(string);

    width: 100%;
    height: 100%;
    background: #000000cc;

    // Full screen touch area to dismiss
    TouchArea {
        clicked => { action("cancel"); }
    }

    // Center card - 2x bigger for easy touch
    Rectangle {
        x: (parent.width - 700px) / 2;
        y: (parent.height - 800px) / 2;
        width: 700px;
        height: 800px;
        border-radius: 48px;
        background: #1a1a24;
        border-width: 4px;
        border-color: #333344;

        VerticalLayout {
            alignment: center;
            spacing: 40px;
            padding: 60px;

            Text {
                text: "System";
                color: #ffffff;
                font-size: 56px;
                horizontal-alignment: center;
            }

            // Lock button
            Rectangle {
                height: 140px;
                border-radius: 32px;
                background: lock-touch.pressed ? #4a9eff : #2a2a34;

                HorizontalLayout {
                    alignment: center;
                    spacing: 32px;
                    Text {
                        text: "üîí";
                        font-size: 64px;
                        vertical-alignment: center;
                    }
                    Text {
                        text: "Lock Screen";
                        color: #ffffff;
                        font-size: 44px;
                        vertical-alignment: center;
                    }
                }

                lock-touch := TouchArea {
                    clicked => { action("lock"); }
                }
            }

            // Reboot button
            Rectangle {
                height: 140px;
                border-radius: 32px;
                background: reboot-touch.pressed ? #ffaa00 : #2a2a34;

                HorizontalLayout {
                    alignment: center;
                    spacing: 32px;
                    Text {
                        text: "üîÑ";
                        font-size: 64px;
                        vertical-alignment: center;
                    }
                    Text {
                        text: "Reboot";
                        color: #ffffff;
                        font-size: 44px;
                        vertical-alignment: center;
                    }
                }

                reboot-touch := TouchArea {
                    clicked => { action("reboot"); }
                }
            }

            // Shutdown button
            Rectangle {
                height: 140px;
                border-radius: 32px;
                background: shutdown-touch.pressed ? #e94560 : #2a2a34;

                HorizontalLayout {
                    alignment: center;
                    spacing: 32px;
                    Text {
                        text: "‚èª";
                        font-size: 64px;
                        vertical-alignment: center;
                    }
                    Text {
                        text: "Power Off";
                        color: #ffffff;
                        font-size: 44px;
                        vertical-alignment: center;
                    }
                }

                shutdown-touch := TouchArea {
                    clicked => { action("shutdown"); }
                }
            }

            // Cancel button
            Rectangle {
                height: 100px;
                border-radius: 24px;
                background: cancel-touch.pressed ? #333344 : transparent;
                border-width: 2px;
                border-color: #444455;

                Text {
                    text: "Cancel";
                    color: #888899;
                    font-size: 36px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }

                cancel-touch := TouchArea {
                    clicked => { action("cancel"); }
                }
            }
        }
    }
}

// App list item for pick default view
component AppListItem inherits Rectangle {
    in property <string> name: "App Name";
    in property <bool> is-selected: false;
    in property <float> text-scale: 2.0;

    callback clicked();

    height: 64px * text-scale;
    background: touch.pressed ? Theme.primary-container : (is-selected ? Theme.surface-variant : transparent);

    HorizontalLayout {
        padding-left: 20px;
        padding-right: 20px;
        spacing: 16px;

        // App icon placeholder
        Rectangle {
            width: 44px * text-scale;
            height: 44px * text-scale;
            border-radius: 10px * text-scale;
            background: Theme.surface-variant;

            Text {
                width: 100%;
                height: 100%;
                text: "‚Ä¢";
                color: Theme.on-surface;
                font-size: 20px * text-scale;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        Text {
            text: name;
            color: Theme.on-surface;
            font-size: 18px * text-scale;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }

        if is-selected: Text {
            text: "‚úì";
            color: Theme.primary;
            font-size: 24px * text-scale;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }
}

// Pick default app view - shows category config with default/custom choice
component PickDefaultView inherits Rectangle {
    in property <string> category-name: "App";
    in property <[AvailableApp]> available-apps: [];
    in property <string> current-selection: "";
    in property <bool> using-flick-default: true;  // Set from Rust - true if using native Flick app
    in property <float> text-scale: 2.0;

    callback app-selected(string);  // Returns exec command
    callback back-pressed();

    width: 100%;
    height: 100%;
    background: Theme.background;

    // Track if user is in custom app selection mode
    property <bool> show-custom-list: false;

    // Use the property passed from Rust
    property <bool> is-flick-default: using-flick-default;

    VerticalLayout {
        padding: 20px;
        spacing: 20px;

        // Header with back button and category name
        Rectangle {
            height: 80px * text-scale;
            background: Theme.surface;
            border-radius: 16px;

            HorizontalLayout {
                padding: 16px;
                spacing: 16px;

                // Back button
                Rectangle {
                    width: 60px * text-scale;
                    height: 60px * text-scale;
                    border-radius: 30px * text-scale;
                    background: back-touch.pressed ? Theme.accent : Theme.surface-variant;

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "‚Üê";
                        color: Theme.on-surface;
                        font-size: 28px * text-scale;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    back-touch := TouchArea {
                        clicked => {
                            if root.show-custom-list {
                                root.show-custom-list = false;
                            } else {
                                back-pressed();
                            }
                        }
                    }
                }

                // Category name
                VerticalLayout {
                    alignment: center;
                    horizontal-stretch: 1;

                    Text {
                        text: root.show-custom-list ? "Select App" : "Configure";
                        color: Theme.on-surface-variant;
                        font-size: 14px * text-scale;
                    }

                    Text {
                        text: category-name;
                        color: Theme.on-surface;
                        font-size: 24px * text-scale;
                        font-weight: 700;
                    }
                }
            }
        }

        // Main content - either choice cards or app list
        if !show-custom-list: VerticalLayout {
            spacing: 16px;
            vertical-stretch: 1;

            // Flick Default option - big touch target
            Rectangle {
                height: 140px * text-scale;
                background: is-flick-default ? Theme.primary-container : Theme.surface;
                border-radius: 20px;
                border-width: is-flick-default ? 3px : 1px;
                border-color: is-flick-default ? Theme.accent : Theme.surface-variant;

                HorizontalLayout {
                    padding: 24px;
                    spacing: 20px;

                    // Checkmark circle
                    Rectangle {
                        width: 48px * text-scale;
                        height: 48px * text-scale;
                        border-radius: 24px * text-scale;
                        background: is-flick-default ? Theme.accent : Theme.surface-variant;

                        Text {
                            width: 100%;
                            height: 100%;
                            text: is-flick-default ? "‚úì" : "";
                            color: #ffffff;
                            font-size: 24px * text-scale;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    VerticalLayout {
                        alignment: center;
                        horizontal-stretch: 1;

                        Text {
                            text: "Flick Default";
                            color: Theme.on-surface;
                            font-size: 22px * text-scale;
                            font-weight: 600;
                        }

                        Text {
                            text: "Use the native Flick app";
                            color: Theme.on-surface-variant;
                            font-size: 14px * text-scale;
                        }
                    }
                }

                TouchArea {
                    clicked => {
                        // Select Flick default - construct the exec path
                        app-selected("flick-default");
                    }
                }
            }

            // Custom App option - big touch target
            Rectangle {
                height: 140px * text-scale;
                background: !is-flick-default ? Theme.primary-container : Theme.surface;
                border-radius: 20px;
                border-width: !is-flick-default ? 3px : 1px;
                border-color: !is-flick-default ? Theme.accent : Theme.surface-variant;

                HorizontalLayout {
                    padding: 24px;
                    spacing: 20px;

                    // Checkmark/arrow circle
                    Rectangle {
                        width: 48px * text-scale;
                        height: 48px * text-scale;
                        border-radius: 24px * text-scale;
                        background: !is-flick-default ? Theme.accent : Theme.surface-variant;

                        Text {
                            width: 100%;
                            height: 100%;
                            text: !is-flick-default ? "‚úì" : "‚Üí";
                            color: #ffffff;
                            font-size: 24px * text-scale;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    VerticalLayout {
                        alignment: center;
                        horizontal-stretch: 1;

                        Text {
                            text: "Custom App";
                            color: Theme.on-surface;
                            font-size: 22px * text-scale;
                            font-weight: 600;
                        }

                        Text {
                            text: !is-flick-default ? "Currently using a Linux app" : "Choose a Linux app";
                            color: Theme.on-surface-variant;
                            font-size: 14px * text-scale;
                        }
                    }
                }

                TouchArea {
                    clicked => {
                        root.show-custom-list = true;
                    }
                }
            }

            // Spacer
            Rectangle {
                vertical-stretch: 1;
            }
        }

        // Custom app list (shown when selecting custom)
        if show-custom-list: Flickable {
            vertical-stretch: 1;
            viewport-height: available-apps.length * (88px * text-scale) + 20px;

            VerticalLayout {
                spacing: 8px;
                padding-bottom: 20px;

                for app[i] in available-apps: Rectangle {
                    property <string> exec-cmd: app.exec;
                    height: 80px * text-scale;
                    background: item-touch.pressed ? Theme.primary-container : (app.exec == current-selection ? Theme.primary-container : Theme.surface);
                    border-radius: 16px;
                    border-width: app.exec == current-selection ? 2px : 0px;
                    border-color: Theme.accent;

                    // TouchArea first, covering entire item
                    item-touch := TouchArea {
                        x: 0;
                        y: 0;
                        width: parent.width;
                        height: parent.height;
                        clicked => { root.app-selected(exec-cmd); }
                    }

                    HorizontalLayout {
                        padding: 20px;
                        spacing: 16px;

                        // Selection indicator
                        Rectangle {
                            width: 32px * text-scale;
                            height: 32px * text-scale;
                            border-radius: 16px * text-scale;
                            background: app.exec == current-selection ? Theme.accent : Theme.surface-variant;

                            Text {
                                width: 100%;
                                height: 100%;
                                text: app.exec == current-selection ? "‚úì" : "";
                                color: #ffffff;
                                font-size: 18px * text-scale;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        Text {
                            text: app.name;
                            color: Theme.on-surface;
                            font-size: 20px * text-scale;
                            vertical-alignment: center;
                            horizontal-stretch: 1;
                            overflow: elide;
                        }
                    }
                }

                // Empty state
                if available-apps.length == 0: Rectangle {
                    height: 120px * text-scale;

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "No Linux apps found";
                        color: Theme.on-surface-variant;
                        font-size: 18px * text-scale;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }
}

// Done button for wiggle mode - large touch-friendly button
component WiggleDoneButton inherits Rectangle {
    in property <float> text-scale: 2.0;
    callback clicked();

    height: 80px * text-scale;
    background: Theme.primary;
    border-radius: 20px * text-scale;

    HorizontalLayout {
        alignment: center;

        Text {
            text: "Done";
            color: #ffffff;
            font-size: 24px * text-scale;
            font-weight: 700;
            vertical-alignment: center;
        }
    }

    TouchArea {
        clicked => { root.clicked(); }
    }
}

// New category tile - shown in wiggle mode to add new app categories
component NewCategoryTile inherits Rectangle {
    in property <float> wiggle-time: 0;

    callback clicked();

    width: 100%;
    height: 100%;
    background: transparent;

    // Subtle wiggle animation like other tiles
    property <length> wiggle-x: sin((wiggle-time * 12 + 17) * 1rad) * 2px;
    property <length> wiggle-y: cos((wiggle-time * 10 + 17) * 1rad) * 1.5px;

    // Calculate sizes
    property <length> icon-size: min(root.width * 0.85, root.height * 0.70);
    property <length> label-height: 40px;
    property <length> total-content-height: icon-size + label-height + 8px;
    property <length> vertical-offset: (root.height - total-content-height) / 2;

    // Plus sign icon container
    Rectangle {
        x: (root.width - root.icon-size) / 2 + root.wiggle-x;
        y: root.vertical-offset + root.wiggle-y;
        width: root.icon-size;
        height: root.icon-size;
        border-radius: root.icon-size * 0.22;
        background: Theme.surface-variant;
        border-width: 3px;
        border-color: Theme.on-surface-variant;

        // Plus sign - horizontal bar
        Rectangle {
            x: (parent.width - parent.width * 0.5) / 2;
            y: (parent.height - 6px) / 2;
            width: parent.width * 0.5;
            height: 6px;
            border-radius: 3px;
            background: Theme.on-surface-variant;
        }

        // Plus sign - vertical bar
        Rectangle {
            x: (parent.width - 6px) / 2;
            y: (parent.height - parent.height * 0.5) / 2;
            width: 6px;
            height: parent.height * 0.5;
            border-radius: 3px;
            background: Theme.on-surface-variant;
        }
    }

    // Label
    Text {
        x: root.wiggle-x;
        y: root.vertical-offset + root.icon-size + 8px + root.wiggle-y;
        width: 100%;
        height: root.label-height;
        text: "New";
        color: Theme.on-surface-variant;
        font-size: 24px;
        horizontal-alignment: center;
        overflow: elide;
    }

    touch-area := TouchArea {
        clicked => { root.clicked(); }
    }
}

// App tile for home screen grid
component AppTile inherits Rectangle {
    in property <string> name: "App";
    in property <image> icon;
    in property <color> tile-color: Theme.primary;
    in property <bool> wiggling: false;
    in property <int> wiggle-phase: 0;  // Phase offset for varied animation
    in property <bool> is-dragging: false;  // True when this tile is being dragged
    in property <float> wiggle-time: 0;  // Time value for wiggle animation (set from Rust)

    callback clicked();
    callback drag-started(float, float);  // x, y position
    callback drag-moved(float, float);    // x, y position
    callback drag-ended(float, float);    // x, y position

    width: 100%;
    height: 100%;
    // Visual feedback when pressed or dragging
    background: (touch-area.pressed || is-dragging) ? Theme.surface-variant.with-alpha(0.3) : transparent;
    // Scale up slightly when dragging
    opacity: is-dragging ? 0.8 : 1.0;

    // Wiggle animation - x/y offset using sin/cos (software renderer compatible)
    property <length> wiggle-x: wiggling && !is-dragging ? sin((wiggle-time * 12 + wiggle-phase * 0.7) * 1rad) * 3px : 0px;
    property <length> wiggle-y: wiggling && !is-dragging ? cos((wiggle-time * 10 + wiggle-phase * 0.5) * 1rad) * 2px : 0px;

    // Calculate sizes - icon takes most of the space, label at bottom
    property <length> icon-size: min(root.width * 0.85, root.height * 0.70);
    property <length> label-height: 40px;
    property <length> total-content-height: icon-size + label-height + 8px;
    property <length> vertical-offset: (root.height - total-content-height) / 2;

    // Container for the icon with wiggle offset - centered in tile
    Rectangle {
        x: (root.width - root.icon-size) / 2 + root.wiggle-x;
        y: root.vertical-offset + root.wiggle-y;
        width: root.icon-size;
        height: root.icon-size;
        border-radius: root.icon-size * 0.22;
        background: tile-color;
        clip: true;

        // Actual icon image
        Image {
            width: 100%;
            height: 100%;
            source: icon;
            image-fit: contain;
        }
    }

    // Name label below icon - centered
    Text {
        x: 4px;
        y: root.vertical-offset + root.icon-size + 8px;
        width: root.width - 8px;
        height: root.label-height;
        text: name;
        color: Theme.on-surface-variant;
        font-size: max(16px, root.width * 0.11);
        horizontal-alignment: center;
        vertical-alignment: top;
        overflow: elide;
    }

    // Track if we started a drag
    property <bool> drag-active: false;

    // TouchArea - handles both clicks and drag gestures during wiggle mode
    touch-area := TouchArea {
        width: 100%;
        height: 100%;

        clicked => {
            if !wiggling {
                root.clicked();
            }
        }

        pointer-event(event) => {
            if wiggling {
                if event.kind == PointerEventKind.down {
                    root.drag-active = true;
                    root.drag-started(self.mouse-x / 1px, self.mouse-y / 1px);
                } else if event.kind == PointerEventKind.up || event.kind == PointerEventKind.cancel {
                    if root.drag-active {
                        root.drag-active = false;
                        root.drag-ended(self.mouse-x / 1px, self.mouse-y / 1px);
                    }
                }
            }
        }

        moved => {
            if wiggling && root.drag-active {
                root.drag-moved(self.mouse-x / 1px, self.mouse-y / 1px);
            }
        }
    }
}

// Notification card component
component NotificationCard inherits Rectangle {
    in property <string> app-name: "App";
    in property <string> app-icon: "üì±";
    in property <string> title: "Notification";
    in property <string> body: "Message body";
    in property <string> time: "now";
    in property <int> urgency: 1;

    callback dismissed();
    callback tapped();

    height: 80px;
    border-radius: 12px;
    background: urgency == 2 ? Theme.error.with-alpha(0.2) : Theme.surface-variant;
    clip: true;

    HorizontalLayout {
        padding: 12px;
        spacing: 12px;

        // App icon
        Rectangle {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: Theme.primary.with-alpha(0.2);

            Text {
                text: app-icon;
                font-size: 20px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Content
        VerticalLayout {
            horizontal-stretch: 1;
            spacing: 2px;
            alignment: center;

            HorizontalLayout {
                Text {
                    text: app-name;
                    color: Theme.on-surface;
                    font-size: 12px;
                    font-weight: 600;
                    horizontal-stretch: 1;
                }
                Text {
                    text: time;
                    color: Theme.on-surface-variant;
                    font-size: 10px;
                }
            }

            Text {
                text: title;
                color: Theme.on-surface;
                font-size: 14px;
                font-weight: 500;
                overflow: elide;
            }

            Text {
                text: body;
                color: Theme.on-surface-variant;
                font-size: 12px;
                overflow: elide;
            }
        }

        // Dismiss button
        Rectangle {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background: Theme.surface;

            Text {
                text: "√ó";
                color: Theme.on-surface-variant;
                font-size: 16px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                clicked => { root.dismissed(); }
            }
        }
    }

    TouchArea {
        clicked => { root.tapped(); }
    }
}

// Quick toggle tile - gradient background with icon circle
component QuickToggle inherits Rectangle {
    in property <string> label: "Toggle";
    in property <image> icon;
    in property <bool> enabled: false;
    in property <color> tile-color: #1a3a5c;  // Base color for gradient

    callback toggled();

    property <color> grad-start: enabled ? tile-color.brighter(40%) : tile-color;
    property <color> grad-end: enabled ? tile-color : tile-color.darker(40%);

    horizontal-stretch: 1;
    height: 140px;  // Fixed height to prevent overflow
    border-radius: 20px;
    background: grad-end;
    clip: true;

    // Gradient overlay (top lighter, bottom darker)
    Rectangle {
        width: 100%;
        height: 50%;
        background: grad-start;
        border-radius: 20px;

        // Fade the bottom edge
        Rectangle {
            y: parent.height - 20px;
            width: 100%;
            height: 20px;
            background: grad-end;
        }
    }

    // Active glow when enabled
    Rectangle {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        background: Theme.accent;
        opacity: enabled ? 0.15 : 0;
    }

    // Subtle border
    Rectangle {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        background: transparent;
        border-width: enabled ? 2px : 1px;
        border-color: enabled ? Theme.accent.with-alpha(0.6) : #ffffff.with-alpha(0.08);
    }

    // Press highlight
    Rectangle {
        width: 100%;
        height: 100%;
        border-radius: 20px;
        background: #ffffff;
        opacity: touch.pressed ? 0.15 : 0;
    }

    // Content
    VerticalLayout {
        alignment: center;
        spacing: 8px;

        // Icon circle
        HorizontalLayout {
            alignment: center;

            Rectangle {
                width: 52px;
                height: 52px;
                border-radius: 26px;
                background: enabled ? Theme.accent : #2a2a3a;
                border-width: 2px;
                border-color: enabled ? Theme.accent : #3a3a4a;

                Image {
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    width: 24px;
                    height: 24px;
                    source: icon;
                    colorize: enabled ? #ffffff : #666677;
                    image-fit: contain;
                }
            }
        }

        // Label
        Text {
            text: label;
            color: enabled ? #ffffff : #777788;
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.5px;
            horizontal-alignment: center;
        }
    }

    touch := TouchArea {
        clicked => { root.toggled(); }
    }
}


// Home screen with app grid - 4 columns, absolute positioning
component HomeScreen inherits Rectangle {
    in property <[AppCategory]> categories: [];
    in property <string> time: "12:00";
    in property <int> battery: 85;
    in property <bool> wiggle-mode: false;
    in property <float> wiggle-time: 0;
    in property <int> dragging-index: -1;
    in property <float> drag-x: 0;
    in property <float> drag-y: 0;
    in property <float> text-scale: 2.0;
    in property <bool> has-wallpaper: false;
    in property <float> scroll-offset: 0;  // Vertical scroll in pixels
    in property <float> push-offset: 0;    // Horizontal push offset (-1.0 to 1.0)

    callback app-tapped(int);
    callback drag-started(int, float, float);
    callback drag-moved(int, float, float);
    callback drag-ended(int, float, float);
    callback new-category-clicked();

    width: 100%;
    height: 100%;
    background: has-wallpaper ? transparent : Theme.background;

    // Calculate grid dimensions
    // Status bar height must match StatusBar component: 54px * text-scale
    property <length> status-bar-height: 54px * text-scale;
    property <length> home-indicator-height: 34px;
    property <length> grid-padding: 12px;
    property <length> grid-spacing: 8px;
    property <length> grid-top: status-bar-height + grid-padding;
    property <length> grid-height: root.height - status-bar-height - home-indicator-height - grid-padding * 2;
    property <length> grid-width: root.width - grid-padding * 2;
    property <int> num-rows: categories.length > 20 ? 6 : (categories.length > 16 ? 5 : (categories.length > 12 ? 4 : (categories.length > 8 ? 3 : (categories.length > 4 ? 2 : 1))));
    property <length> tile-width: (grid-width - grid-spacing * 3) / 4;
    property <length> tile-height: (grid-height - grid-spacing * (num-rows - 1)) / num-rows;
    property <length> push-amount: push-offset * root.width * 0.3;  // Icons move 30% of screen width

    // Status bar
    StatusBar {
        x: 0;
        y: 0;
        width: 100%;
        time: root.time;
        battery: root.battery;
        wifi: true;
        text-scale: root.text-scale;
    }

    // Scrollable grid container with clipping
    Rectangle {
        x: 0;
        y: grid-top;
        width: 100%;
        height: grid-height;
        background: transparent;
        clip: true;

    // App tiles with absolute positioning (inside clipping container)
    // Row 0
    if categories.length > 0: AppTile {
        x: grid-padding + push-amount;
        y: 0px - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[0].name;
        icon: categories[0].icon;
        tile-color: categories[0].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 0;
        is-dragging: root.dragging-index == 0;
        clicked => { app-tapped(0); }
    }
    if categories.length > 1: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: 0px - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[1].name;
        icon: categories[1].icon;
        tile-color: categories[1].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 1;
        is-dragging: root.dragging-index == 1;
        clicked => { app-tapped(1); }
    }
    if categories.length > 2: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: 0px - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[2].name;
        icon: categories[2].icon;
        tile-color: categories[2].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 2;
        is-dragging: root.dragging-index == 2;
        clicked => { app-tapped(2); }
    }
    if categories.length > 3: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: 0px - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[3].name;
        icon: categories[3].icon;
        tile-color: categories[3].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 3;
        is-dragging: root.dragging-index == 3;
        clicked => { app-tapped(3); }
    }

    // Row 1
    if categories.length > 4: AppTile {
        x: grid-padding + push-amount;
        y: tile-height + grid-spacing - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[4].name;
        icon: categories[4].icon;
        tile-color: categories[4].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 4;
        is-dragging: root.dragging-index == 4;
        clicked => { app-tapped(4); }
    }
    if categories.length > 5: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: tile-height + grid-spacing - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[5].name;
        icon: categories[5].icon;
        tile-color: categories[5].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 5;
        is-dragging: root.dragging-index == 5;
        clicked => { app-tapped(5); }
    }
    if categories.length > 6: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: tile-height + grid-spacing - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[6].name;
        icon: categories[6].icon;
        tile-color: categories[6].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 6;
        is-dragging: root.dragging-index == 6;
        clicked => { app-tapped(6); }
    }
    if categories.length > 7: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: tile-height + grid-spacing - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[7].name;
        icon: categories[7].icon;
        tile-color: categories[7].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 7;
        is-dragging: root.dragging-index == 7;
        clicked => { app-tapped(7); }
    }

    // Row 2
    if categories.length > 8: AppTile {
        x: grid-padding + push-amount;
        y: (tile-height + grid-spacing) * 2 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[8].name;
        icon: categories[8].icon;
        tile-color: categories[8].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 8;
        is-dragging: root.dragging-index == 8;
        clicked => { app-tapped(8); }
    }
    if categories.length > 9: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: (tile-height + grid-spacing) * 2 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[9].name;
        icon: categories[9].icon;
        tile-color: categories[9].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 9;
        is-dragging: root.dragging-index == 9;
        clicked => { app-tapped(9); }
    }
    if categories.length > 10: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: (tile-height + grid-spacing) * 2 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[10].name;
        icon: categories[10].icon;
        tile-color: categories[10].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 10;
        is-dragging: root.dragging-index == 10;
        clicked => { app-tapped(10); }
    }
    if categories.length > 11: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: (tile-height + grid-spacing) * 2 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[11].name;
        icon: categories[11].icon;
        tile-color: categories[11].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 11;
        is-dragging: root.dragging-index == 11;
        clicked => { app-tapped(11); }
    }

    // Row 3
    if categories.length > 12: AppTile {
        x: grid-padding + push-amount;
        y: (tile-height + grid-spacing) * 3 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[12].name;
        icon: categories[12].icon;
        tile-color: categories[12].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 12;
        is-dragging: root.dragging-index == 12;
        clicked => { app-tapped(12); }
    }
    if categories.length > 13: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: (tile-height + grid-spacing) * 3 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[13].name;
        icon: categories[13].icon;
        tile-color: categories[13].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 13;
        is-dragging: root.dragging-index == 13;
        clicked => { app-tapped(13); }
    }
    if categories.length > 14: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: (tile-height + grid-spacing) * 3 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[14].name;
        icon: categories[14].icon;
        tile-color: categories[14].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 14;
        is-dragging: root.dragging-index == 14;
        clicked => { app-tapped(14); }
    }
    if categories.length > 15: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: (tile-height + grid-spacing) * 3 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[15].name;
        icon: categories[15].icon;
        tile-color: categories[15].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 15;
        is-dragging: root.dragging-index == 15;
        clicked => { app-tapped(15); }
    }

    // Row 4
    if categories.length > 16: AppTile {
        x: grid-padding + push-amount;
        y: (tile-height + grid-spacing) * 4 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[16].name;
        icon: categories[16].icon;
        tile-color: categories[16].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 16;
        is-dragging: root.dragging-index == 16;
        clicked => { app-tapped(16); }
    }
    if categories.length > 17: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: (tile-height + grid-spacing) * 4 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[17].name;
        icon: categories[17].icon;
        tile-color: categories[17].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 17;
        is-dragging: root.dragging-index == 17;
        clicked => { app-tapped(17); }
    }
    if categories.length > 18: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: (tile-height + grid-spacing) * 4 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[18].name;
        icon: categories[18].icon;
        tile-color: categories[18].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 18;
        is-dragging: root.dragging-index == 18;
        clicked => { app-tapped(18); }
    }
    if categories.length > 19: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: (tile-height + grid-spacing) * 4 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[19].name;
        icon: categories[19].icon;
        tile-color: categories[19].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 19;
        is-dragging: root.dragging-index == 19;
        clicked => { app-tapped(19); }
    }

    // Row 5
    if categories.length > 20: AppTile {
        x: grid-padding + push-amount;
        y: (tile-height + grid-spacing) * 5 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[20].name;
        icon: categories[20].icon;
        tile-color: categories[20].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 20;
        is-dragging: root.dragging-index == 20;
        clicked => { app-tapped(20); }
    }
    if categories.length > 21: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: (tile-height + grid-spacing) * 5 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[21].name;
        icon: categories[21].icon;
        tile-color: categories[21].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 21;
        is-dragging: root.dragging-index == 21;
        clicked => { app-tapped(21); }
    }
    if categories.length > 22: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: (tile-height + grid-spacing) * 5 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[22].name;
        icon: categories[22].icon;
        tile-color: categories[22].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 22;
        is-dragging: root.dragging-index == 22;
        clicked => { app-tapped(22); }
    }
    if categories.length > 23: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: (tile-height + grid-spacing) * 5 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[23].name;
        icon: categories[23].icon;
        tile-color: categories[23].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 23;
        is-dragging: root.dragging-index == 23;
        clicked => { app-tapped(23); }
    }

    // Row 6
    if categories.length > 24: AppTile {
        x: grid-padding + push-amount;
        y: (tile-height + grid-spacing) * 6 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[24].name;
        icon: categories[24].icon;
        tile-color: categories[24].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 24;
        is-dragging: root.dragging-index == 24;
        clicked => { app-tapped(24); }
    }
    if categories.length > 25: AppTile {
        x: grid-padding + tile-width + grid-spacing + push-amount;
        y: (tile-height + grid-spacing) * 6 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[25].name;
        icon: categories[25].icon;
        tile-color: categories[25].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 25;
        is-dragging: root.dragging-index == 25;
        clicked => { app-tapped(25); }
    }
    if categories.length > 26: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 2 + push-amount;
        y: (tile-height + grid-spacing) * 6 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[26].name;
        icon: categories[26].icon;
        tile-color: categories[26].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 26;
        is-dragging: root.dragging-index == 26;
        clicked => { app-tapped(26); }
    }
    if categories.length > 27: AppTile {
        x: grid-padding + (tile-width + grid-spacing) * 3 + push-amount;
        y: (tile-height + grid-spacing) * 6 - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        name: categories[27].name;
        icon: categories[27].icon;
        tile-color: categories[27].color;
        wiggling: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        wiggle-phase: 27;
        is-dragging: root.dragging-index == 27;
        clicked => { app-tapped(27); }
    }

    // New category tile - appears in wiggle mode at the next available position
    // Only show when less than 28 categories (max grid size) and in wiggle mode
    if wiggle-mode && categories.length < 28: NewCategoryTile {
        // Position at index = categories.length (next available slot)
        // Column = index % 4, Row = index / 4
        x: grid-padding + (tile-width + grid-spacing) * mod(categories.length, 4) + push-amount;
        y: (tile-height + grid-spacing) * floor(categories.length / 4) - scroll-offset * 1px;
        width: tile-width;
        height: tile-height;
        wiggle-time: root.wiggle-time;
        clicked => { new-category-clicked(); }
    }

    }  // End of scrollable grid container

    // Home indicator at bottom
    HomeIndicator {
        y: root.height - home-indicator-height;
        width: 100%;
    }

    // Floating dragged tile overlay - shows when dragging an icon
    if dragging-index >= 0 && dragging-index < categories.length: Rectangle {
        x: drag-x * 1px - 100px;  // Center the tile on the finger
        y: drag-y * 1px - 120px;  // Offset up slightly so finger doesn't cover it
        width: 200px;
        height: 240px;
        background: transparent;

        // The tile icon
        Rectangle {
            x: 25px;
            y: 0;
            width: 150px;
            height: 150px;
            border-radius: 33px;
            background: categories[dragging-index].color;
            opacity: 0.9;
            clip: true;

            Image {
                width: 100%;
                height: 100%;
                source: categories[dragging-index].icon;
                image-fit: contain;
            }
        }

        // Name label
        Text {
            x: 0;
            y: 160px;
            width: 100%;
            height: 40px;
            text: categories[dragging-index].name;
            color: Theme.on-surface;
            font-size: 24px;
            horizontal-alignment: center;
            overflow: elide;
        }
    }
}

// Quick settings panel - modern grid-based control center
component QuickSettingsPanel inherits Rectangle {
    in property <float> brightness: 0.7;
    in property <int> volume: 50;
    in property <bool> muted: false;
    in property <bool> wifi-enabled: true;
    in property <bool> bluetooth-enabled: false;
    in property <bool> dnd-enabled: false;
    in property <bool> flashlight-enabled: false;
    in property <bool> airplane-enabled: false;
    in property <bool> touch-effects-enabled: true;
    in property <bool> voice2g-enabled: false;  // 2G mode for voice calls
    in property <string> wifi-ssid: "Home WiFi";
    in property <int> battery-percent: 85;
    in property <string> time: "12:00";
    in property <[Notification]> notifications: [];
    in property <UiIcons> icons;
    in property <bool> has-wallpaper: false;

    callback brightness-changed(float);
    callback volume-changed(int);
    callback wifi-toggled();
    callback bluetooth-toggled();
    callback dnd-toggled();
    callback flashlight-toggled();
    callback airplane-toggled();
    callback touch-effects-toggled();
    callback voice2g-toggled();
    callback lock-pressed();
    callback settings-pressed();
    callback notification-dismissed(int);
    callback notification-tapped(int);
    callback clear-all-notifications();

    width: 100%;
    height: 100%;
    background: has-wallpaper ? #cc0a0a0f : Theme.background;

    VerticalLayout {
        padding: 0px;
        spacing: 0px;

        // Hero header with time, battery and ambient glow
        Rectangle {
            height: 140px;
            background: transparent;

            // Ambient glow effect
            Rectangle {
                x: (parent.width - 400px) / 2;
                y: (parent.height - 180px) / 2;
                width: 400px;
                height: 180px;
                border-radius: 200px;
                background: Theme.accent;
                opacity: 0.06;
            }

            // Content
            HorizontalLayout {
                padding-left: 32px;
                padding-right: 32px;
                alignment: center;
                spacing: 40px;

                // Large time
                Text {
                    text: time;
                    color: Theme.on-surface;
                    font-size: 72px;
                    font-weight: 300;
                    letter-spacing: 4px;
                    vertical-alignment: center;
                }

                // Battery with icon
                HorizontalLayout {
                    spacing: 8px;
                    alignment: center;

                    Text {
                        text: battery-percent + "%";
                        color: battery-percent > 20 ? Theme.on-surface-variant : Theme.error;
                        font-size: 24px;
                        font-weight: 500;
                        vertical-alignment: center;
                    }

                    // Simple battery icon
                    Rectangle {
                        width: 28px;
                        height: 14px;
                        border-radius: 3px;
                        background: transparent;
                        border-width: 2px;
                        border-color: battery-percent > 20 ? Theme.on-surface-variant : Theme.error;

                        // Fill level
                        Rectangle {
                            x: 2px;
                            y: 2px;
                            width: (parent.width - 4px) * battery-percent / 100;
                            height: parent.height - 4px;
                            border-radius: 1px;
                            background: battery-percent > 20 ? Theme.on-surface-variant : Theme.error;
                        }

                        // Battery tip
                        Rectangle {
                            x: parent.width;
                            y: (parent.height - 6px) / 2;
                            width: 3px;
                            height: 6px;
                            border-radius: 1px;
                            background: battery-percent > 20 ? Theme.on-surface-variant : Theme.error;
                        }
                    }
                }
            }

            // Bottom accent line
            Rectangle {
                y: parent.height - 1px;
                width: 100%;
                height: 1px;
                background: Theme.accent;
                opacity: 0.4;
            }
        }

        // Toggle grid - 4x2 with proper spacing
        Rectangle {
            height: 324px;  // 140px * 2 rows + 12px spacing + 32px padding
            background: transparent;

            VerticalLayout {
                padding: 16px;
                spacing: 12px;

                // Row 1: WiFi, Bluetooth, DND, Flash
                HorizontalLayout {
                    spacing: 12px;

                    QuickToggle {
                        label: "WiFi";
                        icon: wifi-enabled ? root.icons.wifi : root.icons.wifi-off;
                        enabled: wifi-enabled;
                        tile-color: #1a3a5c;
                        toggled => { wifi-toggled(); }
                    }

                    QuickToggle {
                        label: "Bluetooth";
                        icon: bluetooth-enabled ? root.icons.bluetooth : root.icons.bluetooth-off;
                        enabled: bluetooth-enabled;
                        tile-color: #2a2a5c;
                        toggled => { bluetooth-toggled(); }
                    }

                    QuickToggle {
                        label: "DND";
                        icon: root.icons.moon;
                        enabled: dnd-enabled;
                        tile-color: #4a2a4a;
                        toggled => { dnd-toggled(); }
                    }

                    QuickToggle {
                        label: "Flash";
                        icon: flashlight-enabled ? root.icons.flashlight : root.icons.flashlight-off;
                        enabled: flashlight-enabled;
                        tile-color: #4a4a2a;
                        toggled => { flashlight-toggled(); }
                    }
                }

                // Row 2: Airplane, 2G, Lock, FX
                HorizontalLayout {
                    spacing: 12px;

                    QuickToggle {
                        label: "Airplane";
                        icon: root.icons.plane;
                        enabled: airplane-enabled;
                        tile-color: #3a3a4a;
                        toggled => { airplane-toggled(); }
                    }

                    QuickToggle {
                        label: "4G";
                        icon: root.icons.volume;  // Signal-like icon
                        enabled: !voice2g-enabled;  // Inverted: ON=LTE (4G data), OFF=2G (voice)
                        tile-color: #2a4a3a;
                        toggled => { voice2g-toggled(); }
                    }

                    QuickToggle {
                        label: "Lock";
                        icon: root.icons.lock;
                        enabled: false;
                        tile-color: #4a2a2a;
                        toggled => { lock-pressed(); }
                    }

                    QuickToggle {
                        label: "FX";
                        icon: root.icons.wand;
                        enabled: touch-effects-enabled;
                        tile-color: #4a2a5a;
                        toggled => { touch-effects-toggled(); }
                    }
                }
            }
        }

        // Sliders section with modern styling
        Rectangle {
            height: 180px;
            background: transparent;

            VerticalLayout {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 8px;
                padding-bottom: 8px;
                spacing: 16px;

                // Brightness slider card
                Rectangle {
                    height: 72px;
                    border-radius: 20px;
                    background: Theme.surface;

                    // Subtle border
                    Rectangle {
                        width: 100%;
                        height: 100%;
                        border-radius: 20px;
                        background: transparent;
                        border-width: 1px;
                        border-color: #ffffff.with-alpha(0.05);
                    }

                    HorizontalLayout {
                        padding: 16px;
                        spacing: 16px;

                        // Icon circle
                        Rectangle {
                            width: 40px;
                            height: 40px;
                            border-radius: 20px;
                            background: #1a1a24;

                            Text {
                                text: "‚òÄ";
                                color: Theme.accent;
                                font-size: 20px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        // Slider area
                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: 4px;

                            Text {
                                text: "Brightness";
                                color: Theme.on-surface-variant;
                                font-size: 12px;
                                font-weight: 500;
                                letter-spacing: 1px;
                            }

                            BrightnessSlider {
                                value: brightness;
                                changed(v) => { brightness-changed(v); }
                            }
                        }
                    }
                }

                // Volume slider card
                Rectangle {
                    height: 72px;
                    border-radius: 20px;
                    background: Theme.surface;

                    // Subtle border
                    Rectangle {
                        width: 100%;
                        height: 100%;
                        border-radius: 20px;
                        background: transparent;
                        border-width: 1px;
                        border-color: #ffffff.with-alpha(0.05);
                    }

                    HorizontalLayout {
                        padding: 16px;
                        spacing: 16px;

                        // Icon circle
                        Rectangle {
                            width: 40px;
                            height: 40px;
                            border-radius: 20px;
                            background: #1a1a24;

                            Text {
                                text: muted ? "üîá" : "üîä";
                                color: muted ? Theme.on-surface-variant : Theme.accent;
                                font-size: 18px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }

                        // Slider area
                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: 4px;

                            Text {
                                text: "Volume";
                                color: Theme.on-surface-variant;
                                font-size: 12px;
                                font-weight: 500;
                                letter-spacing: 1px;
                            }

                            VolumeSlider {
                                value: volume;
                                muted: muted;
                                changed(v) => { volume-changed(v); }
                            }
                        }
                    }
                }
            }
        }

        // Notifications section header
        Rectangle {
            height: 50px;
            background: transparent;

            HorizontalLayout {
                padding-left: 24px;
                padding-right: 24px;
                alignment: center;

                Text {
                    text: "NOTIFICATIONS";
                    color: Theme.on-surface-variant;
                    font-size: 12px;
                    font-weight: 500;
                    letter-spacing: 3px;
                    horizontal-stretch: 1;
                    vertical-alignment: center;
                }

                Rectangle {
                    width: 80px;
                    height: 32px;
                    border-radius: 16px;
                    background: notifications.length > 0 ? Theme.surface : transparent;
                    visible: notifications.length > 0;

                    Text {
                        text: "Clear all";
                        color: Theme.accent;
                        font-size: 12px;
                        font-weight: 500;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    TouchArea {
                        clicked => { clear-all-notifications(); }
                    }
                }
            }

            // Separator line
            Rectangle {
                y: parent.height - 1px;
                x: 24px;
                width: parent.width - 48px;
                height: 1px;
                background: Theme.surface;
            }
        }

        // Notifications list or empty state
        Rectangle {
            vertical-stretch: 1;
            background: transparent;

            if notifications.length == 0: VerticalLayout {
                alignment: center;
                spacing: 12px;

                Text {
                    text: "üîî";
                    font-size: 48px;
                    horizontal-alignment: center;
                    opacity: 0.5;
                }

                Text {
                    text: "No notifications";
                    color: Theme.on-surface-variant;
                    font-size: 16px;
                    horizontal-alignment: center;
                }
            }

            // Notification cards with padding
            VerticalLayout {
                padding: 16px;
                spacing: 8px;

                for notification[idx] in notifications: NotificationCard {
                    app-name: notification.app-name;
                    app-icon: notification.app-icon;
                    title: notification.title;
                    body: notification.body;
                    time: notification.time;
                    urgency: notification.urgency;
                    dismissed => { notification-dismissed(notification.id); }
                    tapped => { notification-tapped(notification.id); }
                }
            }
        }

        HomeIndicator {}
    }
}

// On-Screen Keyboard Key - touch area fills entire cell, visual key has padding
component KeyboardKey inherits Rectangle {
    in property <string> label: "";
    in property <string> shift-label: "";  // Label when shift is active
    in property <bool> shifted: false;
    in property <float> width-factor: 1.0;  // 1.0 = normal, 1.5 = 1.5x width, etc.
    in property <bool> is-special: false;  // Special keys (shift, backspace, etc.)
    in property <bool> is-active: false;  // For toggle keys like shift
    in property <bool> is-accent: false;  // Use accent color
    in property <int> font-size-override: 0;  // 0 = auto

    callback pressed();

    // Use stretch to fill available space proportionally
    horizontal-stretch: width-factor;
    vertical-stretch: 1;
    background: transparent;

    // Inner visual key with padding
    Rectangle {
        x: 2px;
        y: 2px;
        width: parent.width - 4px;
        height: parent.height - 4px;
        border-radius: 8px;
        background: touch.pressed ? Theme.primary :
                    is-accent ? Theme.accent-dim :
                    (is-special ? (is-active ? Theme.primary-container : #252530) : #1e1e28);

        // Subtle gradient overlay for depth
        Rectangle {
            width: 100%;
            height: 50%;
            border-radius: parent.border-radius;
            background: #ffffff08;
        }

        Text {
            width: 100%;
            height: 100%;
            text: root.shifted && root.shift-label != "" ? root.shift-label : root.label;
            color: Theme.on-surface;
            font-size: font-size-override > 0 ? (font-size-override * 1px) : (is-special ? 22px : 32px);
            font-weight: 500;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        width: 100%;
        height: 100%;
        clicked => { root.pressed(); }
    }
}

// Word prediction button - large text for easy reading
component PredictionButton inherits Rectangle {
    in property <string> word: "";
    callback selected(string);

    horizontal-stretch: 1;
    background: transparent;

    Rectangle {
        x: 4px;
        y: 4px;
        width: parent.width - 8px;
        height: parent.height - 8px;
        border-radius: 12px;
        background: touch.pressed ? Theme.primary-container : #1a1a24;
        border-width: 1px;
        border-color: #404055;

        Text {
            width: 100%;
            height: 100%;
            text: root.word;
            color: root.word != "" ? Theme.on-surface : Theme.on-surface-variant;
            font-size: 32px;
            font-weight: 600;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    touch := TouchArea {
        width: 100%;
        height: 100%;
        clicked => {
            if root.word != "" {
                root.selected(root.word);
            }
        }
    }
}

// On-Screen Keyboard - Enhanced with predictions, emoji, terminal mode
component OnScreenKeyboard inherits Rectangle {
    in property <bool> shifted: false;
    in property <bool> caps-lock: false;
    in-out property <int> layout: 0;  // 0 = letters, 1 = numbers/symbols, 2 = emoji, 3 = terminal
    in property <length> container-height: 720px;

    // Word predictions
    in property <string> prediction1: "";
    in property <string> prediction2: "";
    in property <string> prediction3: "";

    callback key-pressed(string);
    callback shift-toggled();
    callback caps-toggled();
    callback backspace-pressed();
    callback enter-pressed();
    callback space-pressed();
    callback layout-toggled();
    callback layout-changed(int);  // For direct layout changes (emoji, terminal)
    callback hide-keyboard();
    callback prediction-selected(string);
    callback special-key-pressed(string);  // For Tab, Esc, Ctrl+C, arrows, etc.

    width: 100%;
    height: max(280px, container-height * 0.32);
    background: #0c0c12;

    property <bool> show-shift: shifted || caps-lock;
    property <bool> ctrl-active: false;

    VerticalLayout {
        width: 100%;
        height: 100%;
        padding: 0px;
        spacing: 0px;

        // Row 0: Word predictions - extra tall for easy touch and readability
        HorizontalLayout {
            height: 90px;
            spacing: 8px;
            padding-left: 8px;
            padding-right: 8px;

            PredictionButton { word: prediction1; selected(w) => { prediction-selected(w); } }
            PredictionButton { word: prediction2; selected(w) => { prediction-selected(w); } }
            PredictionButton { word: prediction3; selected(w) => { prediction-selected(w); } }
        }

        // Row 1: Number row (always visible) OR emoji/terminal content
        HorizontalLayout {
            spacing: 0px;
            vertical-stretch: 1;

            if layout == 0 || layout == 1: KeyboardKey { label: "1"; shift-label: "!"; shifted: show-shift; pressed => { key-pressed(show-shift ? "!" : "1"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "2"; shift-label: "@"; shifted: show-shift; pressed => { key-pressed(show-shift ? "@" : "2"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "3"; shift-label: "#"; shifted: show-shift; pressed => { key-pressed(show-shift ? "#" : "3"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "4"; shift-label: "$"; shifted: show-shift; pressed => { key-pressed(show-shift ? "$" : "4"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "5"; shift-label: "%"; shifted: show-shift; pressed => { key-pressed(show-shift ? "%" : "5"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "6"; shift-label: "^"; shifted: show-shift; pressed => { key-pressed(show-shift ? "^" : "6"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "7"; shift-label: "&"; shifted: show-shift; pressed => { key-pressed(show-shift ? "&" : "7"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "8"; shift-label: "*"; shifted: show-shift; pressed => { key-pressed(show-shift ? "*" : "8"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "9"; shift-label: "("; shifted: show-shift; pressed => { key-pressed(show-shift ? "(" : "9"); } }
            if layout == 0 || layout == 1: KeyboardKey { label: "0"; shift-label: ")"; shifted: show-shift; pressed => { key-pressed(show-shift ? ")" : "0"); } }

            // Emoji row 1
            if layout == 2: KeyboardKey { label: "üòÄ"; pressed => { key-pressed("üòÄ"); } }
            if layout == 2: KeyboardKey { label: "üòÇ"; pressed => { key-pressed("üòÇ"); } }
            if layout == 2: KeyboardKey { label: "ü•∞"; pressed => { key-pressed("ü•∞"); } }
            if layout == 2: KeyboardKey { label: "üòé"; pressed => { key-pressed("üòé"); } }
            if layout == 2: KeyboardKey { label: "ü§î"; pressed => { key-pressed("ü§î"); } }
            if layout == 2: KeyboardKey { label: "üò≠"; pressed => { key-pressed("üò≠"); } }
            if layout == 2: KeyboardKey { label: "üò°"; pressed => { key-pressed("üò°"); } }
            if layout == 2: KeyboardKey { label: "ü•≥"; pressed => { key-pressed("ü•≥"); } }
            if layout == 2: KeyboardKey { label: "üò¥"; pressed => { key-pressed("üò¥"); } }
            if layout == 2: KeyboardKey { label: "ü§Ø"; pressed => { key-pressed("ü§Ø"); } }

            // Terminal row 1: Control keys
            if layout == 3: KeyboardKey { label: "Esc"; is-special: true; pressed => { special-key-pressed("Escape"); } }
            if layout == 3: KeyboardKey { label: "Tab"; is-special: true; pressed => { special-key-pressed("Tab"); } }
            if layout == 3: KeyboardKey { label: "Ctrl"; is-special: true; is-active: ctrl-active; pressed => { ctrl-active = !ctrl-active; } }
            if layout == 3: KeyboardKey { label: "‚Üë"; is-special: true; pressed => { special-key-pressed("Up"); } }
            if layout == 3: KeyboardKey { label: "‚Üì"; is-special: true; pressed => { special-key-pressed("Down"); } }
            if layout == 3: KeyboardKey { label: "‚Üê"; is-special: true; pressed => { special-key-pressed("Left"); } }
            if layout == 3: KeyboardKey { label: "‚Üí"; is-special: true; pressed => { special-key-pressed("Right"); } }
            if layout == 3: KeyboardKey { label: "Home"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("Home"); } }
            if layout == 3: KeyboardKey { label: "End"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("End"); } }
            if layout == 3: KeyboardKey { label: "PgUp"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("Page_Up"); } }
        }

        // Row 2: QWERTY row 1 OR more emoji/terminal
        HorizontalLayout {
            spacing: 0px;
            vertical-stretch: 1;

            if layout == 0: KeyboardKey { label: "q"; shift-label: "Q"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Q" : "q"); } }
            if layout == 0: KeyboardKey { label: "w"; shift-label: "W"; shifted: show-shift; pressed => { key-pressed(show-shift ? "W" : "w"); } }
            if layout == 0: KeyboardKey { label: "e"; shift-label: "E"; shifted: show-shift; pressed => { key-pressed(show-shift ? "E" : "e"); } }
            if layout == 0: KeyboardKey { label: "r"; shift-label: "R"; shifted: show-shift; pressed => { key-pressed(show-shift ? "R" : "r"); } }
            if layout == 0: KeyboardKey { label: "t"; shift-label: "T"; shifted: show-shift; pressed => { key-pressed(show-shift ? "T" : "t"); } }
            if layout == 0: KeyboardKey { label: "y"; shift-label: "Y"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Y" : "y"); } }
            if layout == 0: KeyboardKey { label: "u"; shift-label: "U"; shifted: show-shift; pressed => { key-pressed(show-shift ? "U" : "u"); } }
            if layout == 0: KeyboardKey { label: "i"; shift-label: "I"; shifted: show-shift; pressed => { key-pressed(show-shift ? "I" : "i"); } }
            if layout == 0: KeyboardKey { label: "o"; shift-label: "O"; shifted: show-shift; pressed => { key-pressed(show-shift ? "O" : "o"); } }
            if layout == 0: KeyboardKey { label: "p"; shift-label: "P"; shifted: show-shift; pressed => { key-pressed(show-shift ? "P" : "p"); } }

            // Symbols layout row 1
            if layout == 1: KeyboardKey { label: "-"; shift-label: "_"; shifted: show-shift; pressed => { key-pressed(show-shift ? "_" : "-"); } }
            if layout == 1: KeyboardKey { label: "="; shift-label: "+"; shifted: show-shift; pressed => { key-pressed(show-shift ? "+" : "="); } }
            if layout == 1: KeyboardKey { label: "["; shift-label: "{"; shifted: show-shift; pressed => { key-pressed(show-shift ? "{" : "["); } }
            if layout == 1: KeyboardKey { label: "]"; shift-label: "}"; shifted: show-shift; pressed => { key-pressed(show-shift ? "}" : "]"); } }
            if layout == 1: KeyboardKey { label: "\\"; shift-label: "|"; shifted: show-shift; pressed => { key-pressed(show-shift ? "|" : "\\"); } }
            if layout == 1: KeyboardKey { label: ";"; shift-label: ":"; shifted: show-shift; pressed => { key-pressed(show-shift ? ":" : ";"); } }
            if layout == 1: KeyboardKey { label: "'"; shift-label: "\""; shifted: show-shift; pressed => { key-pressed(show-shift ? "\"" : "'"); } }
            if layout == 1: KeyboardKey { label: "/"; shift-label: "?"; shifted: show-shift; pressed => { key-pressed(show-shift ? "?" : "/"); } }
            if layout == 1: KeyboardKey { label: "`"; shift-label: "~"; shifted: show-shift; pressed => { key-pressed(show-shift ? "~" : "`"); } }
            if layout == 1: KeyboardKey { label: "<"; shift-label: ">"; shifted: show-shift; pressed => { key-pressed(show-shift ? ">" : "<"); } }

            // Emoji row 2
            if layout == 2: KeyboardKey { label: "‚ù§Ô∏è"; pressed => { key-pressed("‚ù§Ô∏è"); } }
            if layout == 2: KeyboardKey { label: "üëç"; pressed => { key-pressed("üëç"); } }
            if layout == 2: KeyboardKey { label: "üëé"; pressed => { key-pressed("üëé"); } }
            if layout == 2: KeyboardKey { label: "üéâ"; pressed => { key-pressed("üéâ"); } }
            if layout == 2: KeyboardKey { label: "üî•"; pressed => { key-pressed("üî•"); } }
            if layout == 2: KeyboardKey { label: "‚ú®"; pressed => { key-pressed("‚ú®"); } }
            if layout == 2: KeyboardKey { label: "üíØ"; pressed => { key-pressed("üíØ"); } }
            if layout == 2: KeyboardKey { label: "üôè"; pressed => { key-pressed("üôè"); } }
            if layout == 2: KeyboardKey { label: "üëÄ"; pressed => { key-pressed("üëÄ"); } }
            if layout == 2: KeyboardKey { label: "üíÄ"; pressed => { key-pressed("üíÄ"); } }

            // Terminal row 2
            if layout == 3: KeyboardKey { label: "C-c"; is-special: true; is-accent: true; pressed => { special-key-pressed("Ctrl+c"); } }
            if layout == 3: KeyboardKey { label: "C-d"; is-special: true; is-accent: true; pressed => { special-key-pressed("Ctrl+d"); } }
            if layout == 3: KeyboardKey { label: "C-z"; is-special: true; pressed => { special-key-pressed("Ctrl+z"); } }
            if layout == 3: KeyboardKey { label: "C-l"; is-special: true; pressed => { special-key-pressed("Ctrl+l"); } }
            if layout == 3: KeyboardKey { label: "C-a"; is-special: true; pressed => { special-key-pressed("Ctrl+a"); } }
            if layout == 3: KeyboardKey { label: "C-e"; is-special: true; pressed => { special-key-pressed("Ctrl+e"); } }
            if layout == 3: KeyboardKey { label: "C-r"; is-special: true; pressed => { special-key-pressed("Ctrl+r"); } }
            if layout == 3: KeyboardKey { label: "C-w"; is-special: true; pressed => { special-key-pressed("Ctrl+w"); } }
            if layout == 3: KeyboardKey { label: "C-u"; is-special: true; pressed => { special-key-pressed("Ctrl+u"); } }
            if layout == 3: KeyboardKey { label: "PgDn"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("Page_Down"); } }
        }

        // Row 3: QWERTY row 2
        HorizontalLayout {
            spacing: 0px;
            vertical-stretch: 1;

            if layout == 0: KeyboardKey { label: "a"; shift-label: "A"; shifted: show-shift; pressed => { key-pressed(show-shift ? "A" : "a"); } }
            if layout == 0: KeyboardKey { label: "s"; shift-label: "S"; shifted: show-shift; pressed => { key-pressed(show-shift ? "S" : "s"); } }
            if layout == 0: KeyboardKey { label: "d"; shift-label: "D"; shifted: show-shift; pressed => { key-pressed(show-shift ? "D" : "d"); } }
            if layout == 0: KeyboardKey { label: "f"; shift-label: "F"; shifted: show-shift; pressed => { key-pressed(show-shift ? "F" : "f"); } }
            if layout == 0: KeyboardKey { label: "g"; shift-label: "G"; shifted: show-shift; pressed => { key-pressed(show-shift ? "G" : "g"); } }
            if layout == 0: KeyboardKey { label: "h"; shift-label: "H"; shifted: show-shift; pressed => { key-pressed(show-shift ? "H" : "h"); } }
            if layout == 0: KeyboardKey { label: "j"; shift-label: "J"; shifted: show-shift; pressed => { key-pressed(show-shift ? "J" : "j"); } }
            if layout == 0: KeyboardKey { label: "k"; shift-label: "K"; shifted: show-shift; pressed => { key-pressed(show-shift ? "K" : "k"); } }
            if layout == 0: KeyboardKey { label: "l"; shift-label: "L"; shifted: show-shift; pressed => { key-pressed(show-shift ? "L" : "l"); } }

            // Symbols row 2
            if layout == 1: KeyboardKey { label: "‚Ç¨"; pressed => { key-pressed("‚Ç¨"); } }
            if layout == 1: KeyboardKey { label: "¬£"; pressed => { key-pressed("¬£"); } }
            if layout == 1: KeyboardKey { label: "¬•"; pressed => { key-pressed("¬•"); } }
            if layout == 1: KeyboardKey { label: "‚Ä¢"; pressed => { key-pressed("‚Ä¢"); } }
            if layout == 1: KeyboardKey { label: "¬∞"; pressed => { key-pressed("¬∞"); } }
            if layout == 1: KeyboardKey { label: "¬©"; pressed => { key-pressed("¬©"); } }
            if layout == 1: KeyboardKey { label: "¬Æ"; pressed => { key-pressed("¬Æ"); } }
            if layout == 1: KeyboardKey { label: "‚Ñ¢"; pressed => { key-pressed("‚Ñ¢"); } }
            if layout == 1: KeyboardKey { label: "‚Ä¶"; pressed => { key-pressed("‚Ä¶"); } }

            // Emoji row 3
            if layout == 2: KeyboardKey { label: "üòä"; pressed => { key-pressed("üòä"); } }
            if layout == 2: KeyboardKey { label: "ü§∑"; pressed => { key-pressed("ü§∑"); } }
            if layout == 2: KeyboardKey { label: "ü§¶"; pressed => { key-pressed("ü§¶"); } }
            if layout == 2: KeyboardKey { label: "üí™"; pressed => { key-pressed("üí™"); } }
            if layout == 2: KeyboardKey { label: "ü§ù"; pressed => { key-pressed("ü§ù"); } }
            if layout == 2: KeyboardKey { label: "üëã"; pressed => { key-pressed("üëã"); } }
            if layout == 2: KeyboardKey { label: "üéµ"; pressed => { key-pressed("üéµ"); } }
            if layout == 2: KeyboardKey { label: "üì±"; pressed => { key-pressed("üì±"); } }
            if layout == 2: KeyboardKey { label: "üíª"; pressed => { key-pressed("üíª"); } }

            // Terminal row 3
            if layout == 3: KeyboardKey { label: "F1"; is-special: true; pressed => { special-key-pressed("F1"); } }
            if layout == 3: KeyboardKey { label: "F2"; is-special: true; pressed => { special-key-pressed("F2"); } }
            if layout == 3: KeyboardKey { label: "F3"; is-special: true; pressed => { special-key-pressed("F3"); } }
            if layout == 3: KeyboardKey { label: "F4"; is-special: true; pressed => { special-key-pressed("F4"); } }
            if layout == 3: KeyboardKey { label: "F5"; is-special: true; pressed => { special-key-pressed("F5"); } }
            if layout == 3: KeyboardKey { label: "F6"; is-special: true; pressed => { special-key-pressed("F6"); } }
            if layout == 3: KeyboardKey { label: "F7"; is-special: true; pressed => { special-key-pressed("F7"); } }
            if layout == 3: KeyboardKey { label: "F8"; is-special: true; pressed => { special-key-pressed("F8"); } }
            if layout == 3: KeyboardKey { label: "Ins"; is-special: true; pressed => { special-key-pressed("Insert"); } }
        }

        // Row 4: shift + letters row 3
        HorizontalLayout {
            spacing: 0px;
            vertical-stretch: 1;

            KeyboardKey {
                label: show-shift ? "‚¨Ü" : "‚áß";
                width-factor: 1.4;
                is-special: true;
                is-active: show-shift;
                pressed => { shift-toggled(); }
            }

            if layout == 0: KeyboardKey { label: "z"; shift-label: "Z"; shifted: show-shift; pressed => { key-pressed(show-shift ? "Z" : "z"); } }
            if layout == 0: KeyboardKey { label: "x"; shift-label: "X"; shifted: show-shift; pressed => { key-pressed(show-shift ? "X" : "x"); } }
            if layout == 0: KeyboardKey { label: "c"; shift-label: "C"; shifted: show-shift; pressed => { key-pressed(show-shift ? "C" : "c"); } }
            if layout == 0: KeyboardKey { label: "v"; shift-label: "V"; shifted: show-shift; pressed => { key-pressed(show-shift ? "V" : "v"); } }
            if layout == 0: KeyboardKey { label: "b"; shift-label: "B"; shifted: show-shift; pressed => { key-pressed(show-shift ? "B" : "b"); } }
            if layout == 0: KeyboardKey { label: "n"; shift-label: "N"; shifted: show-shift; pressed => { key-pressed(show-shift ? "N" : "n"); } }
            if layout == 0: KeyboardKey { label: "m"; shift-label: "M"; shifted: show-shift; pressed => { key-pressed(show-shift ? "M" : "m"); } }

            // Symbols row 3
            if layout == 1: KeyboardKey { label: "¬´"; pressed => { key-pressed("¬´"); } }
            if layout == 1: KeyboardKey { label: "¬ª"; pressed => { key-pressed("¬ª"); } }
            if layout == 1: KeyboardKey { label: "¬ø"; pressed => { key-pressed("¬ø"); } }
            if layout == 1: KeyboardKey { label: "¬°"; pressed => { key-pressed("¬°"); } }
            if layout == 1: KeyboardKey { label: "¬ß"; pressed => { key-pressed("¬ß"); } }
            if layout == 1: KeyboardKey { label: "¬∂"; pressed => { key-pressed("¬∂"); } }
            if layout == 1: KeyboardKey { label: "¬±"; pressed => { key-pressed("¬±"); } }

            // Emoji row 4
            if layout == 2: KeyboardKey { label: "‚òÄÔ∏è"; pressed => { key-pressed("‚òÄÔ∏è"); } }
            if layout == 2: KeyboardKey { label: "üåô"; pressed => { key-pressed("üåô"); } }
            if layout == 2: KeyboardKey { label: "‚≠ê"; pressed => { key-pressed("‚≠ê"); } }
            if layout == 2: KeyboardKey { label: "üåà"; pressed => { key-pressed("üåà"); } }
            if layout == 2: KeyboardKey { label: "‚òï"; pressed => { key-pressed("‚òï"); } }
            if layout == 2: KeyboardKey { label: "üçï"; pressed => { key-pressed("üçï"); } }
            if layout == 2: KeyboardKey { label: "üéÆ"; pressed => { key-pressed("üéÆ"); } }

            // Terminal row 4
            if layout == 3: KeyboardKey { label: "F9"; is-special: true; pressed => { special-key-pressed("F9"); } }
            if layout == 3: KeyboardKey { label: "F10"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("F10"); } }
            if layout == 3: KeyboardKey { label: "F11"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("F11"); } }
            if layout == 3: KeyboardKey { label: "F12"; is-special: true; font-size-override: 14; pressed => { special-key-pressed("F12"); } }
            if layout == 3: KeyboardKey { label: "Del"; is-special: true; pressed => { special-key-pressed("Delete"); } }
            if layout == 3: KeyboardKey { label: "|"; pressed => { key-pressed("|"); } }
            if layout == 3: KeyboardKey { label: "~"; pressed => { key-pressed("~"); } }

            KeyboardKey {
                label: "‚å´";
                width-factor: 1.4;
                is-special: true;
                pressed => { backspace-pressed(); }
            }
        }

        // Row 5: Bottom row with mode toggles
        HorizontalLayout {
            spacing: 0px;
            vertical-stretch: 1;

            KeyboardKey {
                label: layout == 0 ? "123" : (layout == 1 ? "ABC" : (layout == 2 ? "ABC" : "ABC"));
                width-factor: 1.2;
                is-special: true;
                pressed => {
                    if layout == 0 {
                        layout-toggled();
                    } else {
                        // Go back to letters
                        layout = 0;
                    }
                }
            }

            KeyboardKey {
                label: "üòÄ";
                width-factor: 1.0;
                is-special: true;
                is-active: layout == 2;
                pressed => {
                    layout = layout == 2 ? 0 : 2;
                    layout-changed(layout);
                }
            }

            KeyboardKey {
                label: "‚å®";
                width-factor: 1.0;
                is-special: true;
                is-active: layout == 3;
                pressed => {
                    layout = layout == 3 ? 0 : 3;
                    layout-changed(layout);
                }
            }

            KeyboardKey {
                label: " ";
                width-factor: 4.5;
                is-special: true;
                pressed => { space-pressed(); }
            }

            KeyboardKey { label: ","; pressed => { key-pressed(","); } }
            KeyboardKey { label: "."; pressed => { key-pressed("."); } }

            KeyboardKey {
                label: "‚Üµ";
                width-factor: 1.5;
                is-special: true;
                is-accent: true;
                pressed => { enter-pressed(); }
            }
        }
    }
}

// App Switcher panel - horizontal fan-out card stack (like Android/iOS)
component AppSwitcherPanel inherits Rectangle {
    in property <[WindowCard]> windows: [];
    in property <float> scroll-offset: 0;  // Horizontal scroll position
    in property <float> enter-progress: 1.0;  // 0.0 = full screen (animating), 1.0 = card size (complete)
    in property <float> push-offset: 0;  // Horizontal push offset for edge swipe gestures (-1 to 1)
    in property <bool> has-wallpaper: false;

    callback window-tapped(int);  // Window ID
    callback close-requested();   // Swipe down to close

    width: 100%;
    height: 100%;
    background: has-wallpaper ? #cc0a0a12 : #0a0a12;

    // Card layout constants (calculated from self dimensions)
    property <length> card-width: self.width * 0.80;
    property <length> card-height: self.height * 0.55;
    property <length> card-spacing: card-width * 0.35;  // 35% spacing = 65% overlap

    // Header bar
    Rectangle {
        y: 0;
        width: 100%;
        height: 60px;
        background: #1a1a2a;

        Text {
            width: 100%;
            height: 100%;
            text: "RECENT APPS";
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }

    // Card area
    Rectangle {
        y: 60px;
        width: 100%;
        height: parent.height - 60px - 40px;

        // Empty state
        if windows.length == 0: Text {
            width: 100%;
            height: 100%;
            text: "NO APPS";
            color: #666688;
            font-size: 32px;
            font-weight: 600;
            horizontal-alignment: center;
            vertical-alignment: center;
        }

        // Fan-out cards - each card positioned based on original-index and scroll
        // Cards are sorted by render order (furthest from center first, center last)
        // so that the center card renders on top
        for window[idx] in windows: Rectangle {
            // Calculate position based on scroll offset using original-index
            // Each card is at: original-index * card-spacing - scroll-offset + center + push
            property <int> pos-idx: window.original-index;
            property <length> push-x: push-offset * root.width * 0.3;  // Same scale as home screen icons
            property <length> base-x: pos-idx * card-spacing - scroll-offset * 1px + (parent.width - card-width) / 2 + push-x;
            property <float> normalized-pos: (pos-idx * card-spacing / 1px - scroll-offset) / (card-spacing / 1px);
            property <float> distance: abs(normalized-pos);
            property <float> base-scale: max(0.75, 1.0 - distance * 0.1);

            // Animation: center card (distance < 0.5) animates from full screen to card size
            property <bool> is-center-card: distance < 0.5;
            property <float> anim-progress: is-center-card ? enter-progress : 1.0;

            // Interpolate between full screen (progress=0) and card size (progress=1)
            // Full screen: x=0, y=0, w=parent.width, h=parent.height
            // Card: x=base-x, y=center, w=card-width*scale, h=card-height*scale
            property <length> target-x: base-x;
            property <length> target-y: (parent.height - card-height * base-scale) / 2;
            property <length> target-w: card-width * base-scale;
            property <length> target-h: card-height * base-scale;

            property <length> full-x: (parent.width - parent.width) / 2;  // 0
            property <length> full-y: 0px;
            property <length> full-w: parent.width;
            property <length> full-h: parent.height;

            property <float> scale: base-scale;

            // Animated position/size (lerp from full to target)
            x: full-x + (target-x - full-x) * anim-progress;
            y: full-y + (target-y - full-y) * anim-progress;
            width: full-w + (target-w - full-w) * anim-progress;
            height: full-h + (target-h - full-h) * anim-progress;
            background: #2a2a4a;
            border-radius: 20px;

            // Drop shadow effect
            Rectangle {
                x: 4px;
                y: 4px;
                width: parent.width;
                height: parent.height;
                background: #00000040;
                border-radius: 20px;
            }

            // Card content
            Rectangle {
                width: 100%;
                height: 100%;
                background: #3a3a5a;
                border-radius: 20px;

                VerticalLayout {
                    padding: 16px;
                    spacing: 8px;

                    // App title bar - shows app class and close button
                    Rectangle {
                        height: 52px;
                        background: #4a4a6a;
                        border-radius: 8px;

                        HorizontalLayout {
                            padding-left: 16px;
                            padding-right: 16px;
                            spacing: 12px;

                            Text {
                                vertical-alignment: center;
                                text: window.app-class;
                                color: #aaaacc;
                                font-size: 20px;
                                font-weight: 500;
                            }

                            Rectangle { horizontal-stretch: 1; }

                            Text {
                                vertical-alignment: center;
                                text: "‚úï";
                                color: #888888;
                                font-size: 22px;
                            }
                        }
                    }

                    // Window content - app preview image or fallback
                    Rectangle {
                        vertical-stretch: 1;
                        background: #252540;
                        border-radius: 8px;
                        clip: true;

                        // App preview image
                        Image {
                            width: 100%;
                            height: 100%;
                            source: window.preview;
                            image-fit: cover;
                            visible: window.preview.width > 0;
                        }

                        // Fallback: show app title if no preview
                        Rectangle {
                            visible: window.preview.width == 0;
                            width: 100%;
                            height: 100%;

                            VerticalLayout {
                                padding: 16px;
                                alignment: center;

                                Text {
                                    text: window.title;
                                    color: white;
                                    font-size: max(28px, parent.width * 0.08);
                                    font-weight: 600;
                                    overflow: elide;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                }
            }

            // TouchArea for tap detection - covers entire card
            touch := TouchArea {
                x: 0;
                y: 0;
                width: parent.width;
                height: parent.height;
                clicked => {
                    debug("Card tapped: " + window.id);
                    window-tapped(window.id);
                }
            }

            // Visual feedback when pressed
            Rectangle {
                visible: touch.pressed;
                width: 100%;
                height: 100%;
                background: #ffffff20;
                border-radius: 20px;
            }
        }
    }

    // Home indicator
    HomeIndicator {
        y: parent.height - 40px;
    }
}

// Incoming call overlay - full screen overlay for incoming calls
component IncomingCallOverlay inherits Rectangle {
    in property <string> caller-number: "Unknown";
    callback answer-pressed();
    callback reject-pressed();

    width: 100%;
    height: 100%;
    background: #1a1a2eee;

    VerticalLayout {
        alignment: center;
        spacing: 30px;
        padding: 40px;

        // Phone icon
        Text {
            text: "\u{1F4DE}";  // Telephone receiver emoji
            font-size: 72px;
            horizontal-alignment: center;
        }

        // "Incoming call" label
        Text {
            text: "Incoming Call";
            font-size: 24px;
            color: Theme.on-surface-variant;
            horizontal-alignment: center;
        }

        // Caller number
        Text {
            text: caller-number;
            font-size: 36px;
            font-weight: 700;
            color: Theme.on-surface;
            horizontal-alignment: center;
        }

        // Spacer
        Rectangle {
            height: 80px;
        }

        // Answer/Reject buttons
        HorizontalLayout {
            alignment: center;
            spacing: 60px;

            // Reject button (red)
            Rectangle {
                width: 80px;
                height: 80px;
                border-radius: 40px;
                background: reject-touch.pressed ? #cc3333 : #ff4444;

                Text {
                    text: "\u{2716}";  // X mark
                    font-size: 36px;
                    color: white;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                }

                reject-touch := TouchArea {
                    clicked => { reject-pressed(); }
                }
            }

            // Answer button (green)
            Rectangle {
                width: 80px;
                height: 80px;
                border-radius: 40px;
                background: answer-touch.pressed ? #33aa33 : #44cc44;

                Text {
                    text: "\u{2714}";  // Check mark
                    font-size: 36px;
                    color: white;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                }

                answer-touch := TouchArea {
                    clicked => { answer-pressed(); }
                }
            }
        }
    }
}

// Main shell component
export component FlickShell inherits Window {
    in property <string> current-view: "lock"; // "lock", "home", "quick-settings", "pick-default", "switcher", "app"
    in property <[AppCategory]> categories: [];
    in property <string> time: "12:00";  // Current time for status bar
    in property <float> brightness: 0.7;
    in property <int> volume: 50;
    in property <bool> muted: false;
    in property <bool> wifi-enabled: true;
    in property <bool> bluetooth-enabled: false;
    in property <bool> dnd-enabled: false;
    in property <bool> flashlight-enabled: false;
    in property <bool> airplane-enabled: false;
    in property <bool> touch-effects-enabled: true;
    in property <bool> voice2g-enabled: false;  // 2G mode for voice calls
    in property <string> wifi-ssid: "WiFi";
    in property <int> battery-percent: 85;
    in property <float> text-scale: 2.0;  // Text scale factor (1.0 = normal, 2.0 = double)
    in property <[Notification]> notifications: [];
    in property <UiIcons> ui-icons;  // Icons for quick settings toggles

    // Popup menu state
    in property <bool> show-popup: false;
    in property <string> popup-category-name: "";
    in property <bool> popup-can-pick-default: true;
    in property <float> popup-x: 100;
    in property <float> popup-y: 200;

    // Context menu state (copy/paste circular menu on long press)
    in property <bool> show-context-menu: false;
    in property <float> context-menu-x: 200;
    in property <float> context-menu-y: 400;
    in property <int> context-menu-highlight: 0;  // 0=none, 1=copy, 2=paste, 3=system
    in property <string> clipboard-preview: "";  // Current clipboard content preview

    // Copied popup notification
    in property <bool> show-copied-popup: false;
    in property <string> copied-popup-text: "";
    in property <float> copied-popup-x: 200;
    in property <float> copied-popup-y: 400;

    // System menu state
    in property <bool> show-system-menu: false;
    callback system-menu-action(string);  // lock, reboot, shutdown

    // Volume overlay state (shown when hardware volume buttons pressed)
    in property <bool> show-volume-overlay: false;

    // Wiggle mode state
    in property <bool> wiggle-mode: false;
    in property <float> wiggle-time: 0;  // Time value for wiggle animation (set from Rust)
    in property <int> dragging-index: -1;  // Index of tile being dragged, -1 if none
    in property <float> drag-x: 0;  // Drag position X (screen coordinates)
    in property <float> drag-y: 0;  // Drag position Y (screen coordinates)

    // Pick default view state
    in property <string> pick-default-category: "";
    in property <[AvailableApp]> available-apps: [];
    in property <string> current-app-selection: "";
    in property <bool> using-flick-default: true;  // True if using native Flick app

    // App switcher state
    in property <[WindowCard]> switcher-windows: [];
    in property <float> switcher-scroll: 0;
    in property <float> switcher-enter-progress: 1.0;  // 0.0 = full screen, 1.0 = card size (animation complete)
    in property <float> switcher-push-offset: 0;  // Horizontal push for edge swipe gestures

    // Home screen scroll state
    in property <float> home-scroll: 0;  // Vertical scroll offset in pixels
    in property <float> home-push-offset: 0;  // Horizontal push offset (-1.0 to 1.0)
    in property <bool> return-gesture-active: false;  // True when swiping back to home from switcher/qs
    in property <bool> forward-gesture-active: false;  // True when swiping from home to switcher

    // Keyboard state
    in property <bool> keyboard-visible: false;
    in property <bool> keyboard-shifted: false;
    in property <bool> keyboard-caps-lock: false;
    in property <int> keyboard-layout: 0;  // 0 = letters, 1 = numbers/symbols, 2 = emoji, 3 = terminal
    in property <length> keyboard-y-offset: 0px;  // For swipe-to-dismiss animation
    in property <string> keyboard-prediction1: "";
    in property <string> keyboard-prediction2: "";
    in property <string> keyboard-prediction3: "";

    // Incoming call state
    in property <bool> incoming-call: false;
    in property <string> incoming-caller: "";

    // Wallpaper
    in property <image> wallpaper;
    in property <bool> has-wallpaper: false;

    callback app-tapped(int);
    callback app-long-pressed(int);
    callback brightness-changed(float);
    callback volume-changed(int);
    callback wifi-toggled();
    callback bluetooth-toggled();
    callback dnd-toggled();
    callback flashlight-toggled();
    callback airplane-toggled();
    callback touch-effects-toggled();
    callback voice2g-toggled();
    callback lock-pressed();
    callback settings-pressed();
    callback notification-dismissed(int);
    callback notification-tapped(int);
    callback clear-all-notifications();

    // Callbacks for popup menu actions
    callback popup-pick-default();
    callback popup-move();
    callback popup-close();
    callback wiggle-done();
    callback new-category-clicked();
    callback pick-default-selected(string);  // exec command
    callback pick-default-back();
    callback switcher-window-tapped(int);  // Window ID

    // Context menu callbacks (copy/paste)
    callback context-menu-copy();
    callback context-menu-paste();
    callback context-menu-cancelled();

    // Keyboard callbacks
    callback keyboard-key-pressed(string);  // Character pressed
    callback keyboard-backspace();
    callback keyboard-enter();
    callback keyboard-space();
    callback keyboard-shift-toggled();
    callback keyboard-layout-toggled();
    callback keyboard-hide();
    callback keyboard-prediction-selected(string);  // Word prediction selected
    callback keyboard-special-key-pressed(string);  // Tab, Esc, Ctrl+key, arrows, F-keys
    callback keyboard-layout-changed(int);  // Direct layout changes (emoji=2, terminal=3)

    // Phone call callbacks
    callback call-answered();
    callback call-rejected();

    title: "Flick Shell";
    // Use magenta as chroma key for transparency in app view (keyboard only)
    // The Rust renderer will replace #FF00FF with transparent pixels
    background: current-view == "app" ? #FF00FF : #1a1a2e;

    // Wallpaper background (shown on home, lock, quick-settings, and switcher)
    if has-wallpaper && current-view != "app": Image {
        width: 100%;
        height: 100%;
        source: wallpaper;
        image-fit: cover;
    }

    // Home screen - visible in home view OR during return gestures (to animate icons sliding back)
    if current-view == "home" || return-gesture-active || forward-gesture-active: HomeScreen {
        width: 100%;
        height: 100%;
        categories: categories;
        time: root.time;
        battery: battery-percent;
        wiggle-mode: root.wiggle-mode;
        wiggle-time: root.wiggle-time;
        dragging-index: root.dragging-index;
        drag-x: root.drag-x;
        drag-y: root.drag-y;
        text-scale: root.text-scale;
        has-wallpaper: root.has-wallpaper;
        scroll-offset: root.home-scroll;
        push-offset: root.home-push-offset;
        app-tapped(i) => { app-tapped(i); }
        new-category-clicked => { new-category-clicked(); }
    }

    // Quick settings - slides down as overlay on top of home
    // Only render when visible (not in app view where we only show keyboard overlay)
    if current-view == "quick-settings": QuickSettingsPanel {
        y: 0px;
        width: 100%;
        height: 100%;
        brightness: brightness;
        volume: volume;
        muted: muted;
        wifi-enabled: wifi-enabled;
        bluetooth-enabled: bluetooth-enabled;
        dnd-enabled: dnd-enabled;
        flashlight-enabled: flashlight-enabled;
        airplane-enabled: airplane-enabled;
        touch-effects-enabled: touch-effects-enabled;
        voice2g-enabled: voice2g-enabled;
        wifi-ssid: wifi-ssid;
        battery-percent: battery-percent;
        notifications: notifications;
        time: root.time;
        icons: root.ui-icons;
        has-wallpaper: root.has-wallpaper;
        brightness-changed(v) => { brightness-changed(v); }
        volume-changed(v) => { volume-changed(v); }
        wifi-toggled => { wifi-toggled(); }
        bluetooth-toggled => { bluetooth-toggled(); }
        dnd-toggled => { dnd-toggled(); }
        flashlight-toggled => { flashlight-toggled(); }
        airplane-toggled => { airplane-toggled(); }
        touch-effects-toggled => { touch-effects-toggled(); }
        voice2g-toggled => { voice2g-toggled(); }
        lock-pressed => { lock-pressed(); }
        settings-pressed => { settings-pressed(); }
        notification-dismissed(id) => { notification-dismissed(id); }
        notification-tapped(id) => { notification-tapped(id); }
        clear-all-notifications => { clear-all-notifications(); }
    }

    // App Switcher - only render when visible
    if current-view == "switcher": AppSwitcherPanel {
        x: 0px;
        width: 100%;
        height: 100%;
        windows: switcher-windows;
        scroll-offset: switcher-scroll;
        enter-progress: switcher-enter-progress;
        push-offset: switcher-push-offset;
        has-wallpaper: root.has-wallpaper;
        window-tapped(id) => { switcher-window-tapped(id); }
    }

    // Lock view - minimal debug message while QML lock screen loads
    if current-view == "lock": Rectangle {
        width: 100%;
        height: 100%;
        background: has-wallpaper ? transparent : #0a0a0f;

        Text {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            text: "Loading QML lockscreen...";
            color: #666677;
            font-size: 18px;
        }
    }

    // Pick default app view
    if current-view == "pick-default": PickDefaultView {
        width: 100%;
        height: 100%;
        category-name: pick-default-category;
        available-apps: available-apps;
        current-selection: current-app-selection;
        using-flick-default: root.using-flick-default;
        text-scale: root.text-scale;
        app-selected(exec) => { pick-default-selected(exec); }
        back-pressed => { pick-default-back(); }
    }


    // Circular context menu (copy/paste) - shown globally on long press
    if show-context-menu: CircularContextMenu {
        center-x: context-menu-x;
        center-y: context-menu-y;
        highlighted-option: context-menu-highlight;
        clipboard-text: clipboard-preview;
    }

    // Copied popup notification
    if show-copied-popup: CopiedPopup {
        pos-x: copied-popup-x;
        pos-y: copied-popup-y;
        copied-text: copied-popup-text;
    }

    // System menu (power options)
    if show-system-menu: SystemMenu {
        action(a) => { system-menu-action(a); }
    }

    // Popup menu overlay (shown on top of home when long press)
    if show-popup && current-view == "home": Rectangle {
        width: 100%;
        height: 100%;
        background: #00000088;

        // Dismiss when tapping outside
        TouchArea {
            clicked => { popup-close(); }
        }

        // Centered popup
        LongPressPopup {
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            category-name: popup-category-name;
            can-pick-default: popup-can-pick-default;
            pick-default-clicked => { popup-pick-default(); }
            move-clicked => { popup-move(); }
            close-clicked => { popup-close(); }
        }
    }

    // Wiggle mode done button (shown at bottom when in wiggle mode)
    // Full-width safe zone at bottom to prevent accidental app picks
    if wiggle-mode && current-view == "home": Rectangle {
        x: 20px;
        y: parent.height - (120px * text-scale) - 40px;  // Above home indicator
        width: parent.width - 40px;
        height: 100px * text-scale;
        background: transparent;

        WiggleDoneButton {
            x: (parent.width - 300px * text-scale) / 2;
            y: (parent.height - self.height) / 2;
            width: 300px * text-scale;
            text-scale: root.text-scale;
            clicked => { wiggle-done(); }
        }
    }

    // On-screen keyboard - slides up from bottom, with swipe-down offset
    OnScreenKeyboard {
        y: keyboard-visible ? parent.height - self.height + keyboard-y-offset : parent.height;
        width: 100%;
        container-height: parent.height;
        shifted: keyboard-shifted;
        caps-lock: keyboard-caps-lock;
        layout: keyboard-layout;
        prediction1: keyboard-prediction1;
        prediction2: keyboard-prediction2;
        prediction3: keyboard-prediction3;
        key-pressed(ch) => { keyboard-key-pressed(ch); }
        shift-toggled => { keyboard-shift-toggled(); }
        backspace-pressed => { keyboard-backspace(); }
        enter-pressed => { keyboard-enter(); }
        space-pressed => { keyboard-space(); }
        layout-toggled => { keyboard-layout-toggled(); }
        hide-keyboard => { keyboard-hide(); }
        prediction-selected(word) => { keyboard-prediction-selected(word); }
        special-key-pressed(key) => { keyboard-special-key-pressed(key); }
        layout-changed(new-layout) => { keyboard-layout-changed(new-layout); }
    }

    // Volume overlay - shown briefly when hardware volume buttons pressed
    if show-volume-overlay: VolumeOverlay {
        x: parent.width - self.width - 20px;
        y: (parent.height - self.height) / 2;
        volume: root.volume;
        muted: root.muted;
    }

    // Incoming call overlay - shown on top of everything when there's an incoming call
    if incoming-call: IncomingCallOverlay {
        caller-number: root.incoming-caller;
        answer-pressed => { call-answered(); }
        reject-pressed => { call-rejected(); }
    }
}
